define("dojo/Stateful dojo dijit dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/html dojo/query dojo/aspect dojo/i18n!esri/nls/jsapi dojo/dom dojo/dom-construct dojo/dom-class dojo/dom-style dojo/on dojo/json dojo/topic dijit/_WidgetsInTemplateMixin jimu/BaseWidget jimu/LayerInfos/LayerInfos jimu/dijit/Message esri/request esri/dijit/editing/TemplatePicker esri/dijit/AttributeInspector esri/toolbars/draw esri/toolbars/edit esri/tasks/query esri/graphic esri/layers/FeatureLayer dojo/promise/all dojo/Deferred esri/symbols/SimpleMarkerSymbol esri/symbols/SimpleLineSymbol esri/symbols/SimpleFillSymbol esri/Color esri/geometry/jsonUtils esri/geometry/Polyline esri/tasks/RelationshipQuery dijit/registry ./PresetAllFields ./utils ./presetUtils ./smartAttributes ./attributeInspectorTools ./relatedTables dijit/form/CheckBox dojox/mobile/Button jimu/PanelManager dijit/form/Button dijit/form/DropDownButton dijit/DropDownMenu dijit/MenuItem dijit/form/DateTextBox dijit/form/NumberSpinner dijit/form/NumberTextBox dijit/form/FilteringSelect dijit/form/TextBox dijit/form/ValidationTextBox dijit/form/TimeTextBox dijit/Editor dijit/form/SimpleTextarea dojo/store/Memory dojo/date/stamp dojo/dom-attr jimu/dijit/Popup ./AttachmentUploader esri/lang esri/renderers/jsonUtils dojox/html/entities jimu/utils jimu/portalUrlUtils jimu/SelectionManager ./SEFilterEditor ./SEDrawingOptions ./PrivilegeUtil ./XYCoordinates jimu/dijit/LoadingIndicator esri/tasks/GeometryService ./coordinateUtils ./addressUtils ./Intersection esri/dijit/LocateButton esri/geometry/Point esri/SpatialReference dijit/focus".split(" "),
function(Ha,u,P,ba,e,g,ca,n,J,y,Ia,k,f,m,r,p,da,ea,fa,ha,F,ia,ja,Ja,t,I,E,Q,C,K,z,L,A,T,D,U,ka,la,M,ma,w,V,na,oa,pa,qa,ra,N,Ka,sa,ta,ua,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,x,R,va,O,wa,xa,S,W,ya,za,G,Aa,Ba,X,Ca,Y,Da,Ea,Fa,Z,Ga,aa){return ba([fa,ea],{name:"SmartEditor",baseClass:"jimu-widget-smartEditor",_defaultStartStr:"",_defaultAddPointStr:"",_jimuLayerInfos:null,_mapClick:null,settings:null,templatePicker:null,attrInspector:null,editToolbar:null,_isDirty:!1,updateFeatures:[],currentFeature:null,currentLayerInfo:null,
_attrInspIsCurrentlyDisplayed:!1,_ignoreEditGeometryToggle:!1,_editingEnabled:!1,_usePresetValues:!1,_creationDisabledOnAll:!1,_editGeomSwitch:null,_autoSaveRuntime:!1,_userHasPrivilege:!1,_eventHandler:null,_createOverDef:null,featureReductionEnabledLayers:[],rendererDifferentLayers:[],clusterState:!0,_relatedTablesInfo:{},_traversal:[],_nodesCollection:[],_paginationNodeCollection:[],_buttonsWrapper:[],_attributeInspectorCollection:[],contentWrapper:null,viewedFeatureDetails:[],viewedLayerDetails:[],
currentAction:null,_isPresetTableCreated:!1,_layerClearSelectionHandles:[],_layerChangedOutside:!1,_refreshButton:null,_mapNavigation:null,_locateButtonDiv:null,_xyCoordinates:null,_coordinates:null,postMixInProperties:function(){this.nls=e.mixin(this.nls,window.jimuNls.common)},postCreate:function(){this.inherited(arguments);this._relatedTablesInfo={};this._traversal=[];this._nodesCollection=[];this._paginationNodeCollection=[];this._buttonsWrapper=[];this._attributeInspectorCollection=[];this.viewedFeatureDetails=
[];this.viewedLayerDetails=[];this._isPresetTableCreated=!1;this._layerClearSelectionHandles=[];this._layerChangedOutside=!1;this.own(r(this.cancelButton,"click",e.hitch(this,function(){this.config.editor.displayPromptOnSave&&this._validateFeatureChanged()?this._promptToResolvePendingEdit(1<this._traversal.length?!1:!0,null,!0).then(e.hitch(this,function(a){this._addingNewRelatedRecord&&"no"!==a?this._processBackButtonInNewRelatedRecord=!0:this._onCancelButtonClicked()}),function(){}):this._onCancelButtonClicked()})))},
_setCancelButtonText:function(){this._traversal&&1<this._traversal.length?x.set(this.cancelButton,"innerHTML",this.nls.back):x.set(this.cancelButton,"innerHTML",this.nls.clearSelection)},_onCancelButtonClicked:function(){this.attrInspector&&(this.attrInspector.layerInfos&&g.forEach(this.attrInspector.layerInfos,function(a){a=a.featureLayer;a.clearSelection();a.refresh()}),this.attrInspector.destroy());k.destroy(this.contentWrapper);k.destroy(this.buttonHeader);this.navButtonsDiv&&k.destroy(this.navButtonsDiv);
if(this._attributeInspectorCollection&&0<this._attributeInspectorCollection.length){var a=this._attributeInspectorCollection.pop();a&&(this.attrInspector=a)}this._traversal&&0<this._traversal.length&&this._traversal.pop();0<this._buttonsWrapper.length&&(this.buttonHeader=this._buttonsWrapper.pop());this._setCancelButtonText();this._unLockMapNavigation();if(this._nodesCollection&&0<this._nodesCollection.length){a=this._nodesCollection.pop();var b=this._paginationNodeCollection.pop();if(a){f.remove(a,
"hidden");f.remove(this.buttonHeader,"hidden");m.set(this.attrInspector.attributeTable,"display","block");m.set(this.attrInspector.editButtons,"display","block");void 0!==this.attrInspector._attachmentEditor&&null!==this.attrInspector._attachmentEditor&&m.set(this.attrInspector._attachmentEditor.domNode,"display","block");m.set(this.attrInspector.deleteBtn.domNode,"display","none");this.attrInspector._featureIdx=this.attrInspector.ctStoredFeatureIndex;this.attrInspector.refresh();setTimeout(e.hitch(this,
function(){m.set(this.attrInspector.navButtons,"display",!this.attrInspector._hideNavButtons&&1<this.attrInspector._numFeatures?"":"none");this.attrInspector.navMessage.innerHTML=O.substitute({idx:this.attrInspector._featureIdx+1,of:this.attrInspector.NLS_of,numFeatures:this.attrInspector._numFeatures},this.attrInspector._navMessage);this._toggleAttrInspectorNavButtons();this.currentFeature=this.attrInspector._numFeatures?this.attrInspector._selection[this.attrInspector._featureIdx]:null;this.currentFeature.preEditAttrs=
p.parse(p.stringify(this.currentFeature.attributes));this.currentLayerInfo=this._getLayerInfoByID(this.currentFeature._layer.id);this._relatedTablesInfo&&this._relatedTablesInfo[this.currentFeature._layer.id]&&this._relatedTablesInfo[this.currentFeature._layer.id].updateRelatedRecordsCount();this._toggleEditGeoSwitch(this.currentLayerInfo.disableGeometryUpdate||!this.currentLayerInfo.configFeatureLayer.layerAllowsUpdate||this.currentLayerInfo.featureLayer.hasZ&&!this.currentLayerInfo.featureLayer.enableZDefaults||
this.currentLayerInfo.featureLayer.hasM&&!this.currentLayerInfo.featureLayer.allowUpdateWithoutMValues);1>=this._traversal.length&&(n(".esriCTItemTitle",this.domNode)[0].style.opacity=this.currentFeature&&this.currentFeature.geometry&&this.currentFeature._layer.visibleAtMapScale?"1":"0.3");this.currentFeature.hasOwnProperty("allowDelete")?this._toggleDeleteButton(this.currentFeature.allowDelete&&this.currentLayerInfo.allowDelete):this._toggleDeleteButton(this.currentLayerInfo.allowDelete);this.currentLayerInfo.featureLayer.visibleAtMapScale&&
this.config.editor.hasOwnProperty("editGeometryDefault")&&!0===this.config.editor.editGeometryDefault&&2>this._traversal.length&&this._editGeomSwitch.domNode&&this._editGeomSwitch.set("checked",!0);this.loading.show();setTimeout(e.hitch(this,function(){!this.attrInspector._attachmentEditor||this.currentLayerInfo.isEditable&&this.currentLayerInfo._editFlag||this._disableAttachments(this.attrInspector._attachmentEditor,!0,!1);this.loading.hide()}),1E3)}),200);this.contentWrapper=a;this.navButtonsDiv=
b;return}}this._attrInspIsCurrentlyDisplayed&&!0===this._attrInspIsCurrentlyDisplayed&&this.attrInspector&&0===this.attrInspector._numFeatures&&this._showTemplate(!0);this.map.infoWindow.isShowing&&this.map.infoWindow.hide();this._removeLayerVisibleHandler()},_createCoordinatesPopup:function(){this._coordinates=new Ba({map:this.map,nls:this.nls,geometryService:this.geometryService});r(this._coordinates,"gotoSelectedLocation",e.hitch(this,function(a){this._getUpdatedLocation(a).then(e.hitch(this,function(a){this.currentFeature.setGeometry(a);
this.map.centerAt(a);this.geometryEdited()}),function(){})}))},_getUpdatedLocation:function(a){var b=new z;var c=parseFloat(a.firstPoint);var d=parseFloat(a.secondPoint);"Map Spatial Reference"===a.coordinateSystem?(a=new Z(c,d,this.map.spatialReference),b.resolve(a)):(a=new Z(d,c,new Ga(4326)),Y.getProjectedGeometry(a,this.map.spatialReference,this.geometryService).then(e.hitch(this,function(a){b.resolve(a)}),function(){}));return b.promise},_toggleAttrInspectorNavButtons:function(){var a;n(".esriAttrPaginationDiv")&&
this._traversal&&(a=n(".esriAttrPaginationDiv")[this._traversal.length-1]);a&&(this.attrInspector&&1<this.attrInspector._selection.length?(m.set(a,"display","block"),a.nextElementSibling&&(m.set(a.nextElementSibling,"max-height","calc(100% - 65px)"),m.set(a.nextElementSibling,"margin-top","5px"))):(m.set(a,"display","none"),a.nextElementSibling&&(m.set(a.nextElementSibling,"max-height","calc(100% - 40px)"),m.set(a.nextElementSibling,"margin-top","0px"))))},startup:function(){this.inherited(arguments);
if(this.appConfig.geometryService){this.geometryService=new Ca(this.appConfig.geometryService);"TabTheme"===this.appConfig.theme.name&&f.add(this.domNode.parentElement,"esriCTOverridePanelStyle");this._createOverDef=new z;this._getSelectedThemeColor();this.config.editor.hasOwnProperty("displayPresetTop")&&!0===this.config.editor.displayPresetTop&&u.place("presetFieldsTableDiv","templatePickerDiv","before");da.subscribe("smartEditor/validate",e.hitch(this,this._validateEventHandler));this._progressDiv=
k.create("div",{"class":"processing-indicator-panel"});var a=this.getParent().domNode.parentNode;a.insertBefore(this._progressDiv,a.firstChild);this.widgetActiveIndicator=k.create("div",{"class":"widgetActive widgetIndicator"});a.insertBefore(this.widgetActiveIndicator,a.firstChild);void 0===this.config.editor.editDescription||null===this.config.editor.editDescription?(this.config.editor.editDescription="",this.templateTitle.innerHTML=this.config.editor.editDescription):this.templateTitle.innerHTML=
xa.decode(this.config.editor.editDescription);this._orignls=y.widgets.attachmentEditor.NLS_attachments;this.loading=new X({hidden:!0});this.loading.placeAt(this.domNode);this.attachmentloading=new X({hidden:!0});this.loading.placeAt(this.domNode);this.editToolbar=new I(this.map);this.drawToolbar=new t(this.map);this._createDrawingToolbar();this.own(r(this.editToolbar,"graphic-move-stop, rotate-stop, scale-stop, vertex-move-stop, vertex-click",e.hitch(this,this.geometryEdited)));this.own(r(this.drawToolbar,
"draw-complete",e.hitch(this,function(a){this.drawToolbar.deactivate();this._addGraphicToLocalLayer(a)})));this.privilegeUtil=Aa.getInstance();this._setTheme();this.shelter.show();ha.getInstance(this.map,this.map.itemInfo).then(e.hitch(this,function(a){var b="BoxTheme"===this.appConfig.theme.name?1050:1;setTimeout(e.hitch(this,function(){this.privilegeUtil.loadPrivileges(this._getPortalUrl()).then(e.hitch(this,function(b){this._user=null;if(b){if(b=this.privilegeUtil.getUser())this._user=b.username;
this.privilegeUtil.userRole.canEditFeatures()}!1===this._initControl(a)&&this._noPrivilegeHandler(window.jimuNls.invalidConfiguration);this.shelter.hide()}),e.hitch(this,function(){this._initControl(a)}));this.shelter.hide();this._workBeforeCreate()}),b)}));(new ra({label:"Back to RPZ Details  &nbsp;&nbsp;&nbsp;&nbsp;<img src='images/rightArrow18_2.png'>",onClick:e.hitch(this,this._back2Info)},"buttonBack2")).startup()}else F({message:this.nls.geometryServiceURLNotFoundMSG})},_back2Info:function(){N.getInstance().showPanel(this.appConfig.widgetPool.widgets[3]);
N.getInstance().closePanel(this.appConfig.widgetPool.widgets[1].id+"_panel")},geometryEdited:function(){this._refreshButton&&this.config.editor.enableAttributeUpdates&&this.config.editor.enableAutomaticAttributeUpdates&&(f.remove(this._refreshButton,"hidden"),f.contains(this._refreshButton,"esriCTAutoUpdateOnMode")&&this._refreshAttributes());this.geometryChanged=!0;this._enableAttrInspectorSaveButton(this._validateAttributes())},_noPrivilegeHandler:function(a){this.templateTitle.innerHTML=a;this.templatePicker&&
(u.style(this.templatePicker.domNode,"display","none"),this.drawingTool&&u.style(this.drawingTool.domNode,"display","none"),this._mapClick&&(this._mapClick.remove(),this._mapClick=null));this.map.setInfoWindowOnClick(!0);this.shelter.hide()},_getPortalUrl:function(a){return a?W.getStandardPortalUrl(a):W.getStandardPortalUrl(this.appConfig.portalUrl)},feature_action_select:function(a,b){if(b&&a&&0!==a.length){"active"!==this.state&&this.widgetManager.activateWidget(this);var c=a[0];this._validateFeatureChanged()&&
this.currentFeature?this.config.editor.displayPromptOnSave&&!0===this.config.editor.displayPromptOnSave?this._promptToResolvePendingEdit(!1,{featureLayer:b,feature:c},!1,!0):this.load_from_featureaction(b,c):this.load_from_featureaction(b,c)}},load_from_featureaction:function(a,b){this._clearLayerSelection();this.contentWrapper&&this.contentWrapper.parentNode&&!f.contains(this.contentWrapper,"hidden")&&(this.contentWrapper.parentNode.removeChild(this.contentWrapper),n(".esriAttrPaginationDiv",this.domNode).forEach(e.hitch(this,
function(a){k.destroy(a)})));this._traversal=[];this._nodesCollection=[];this._paginationNodeCollection=[];this._buttonsWrapper=[];this._attributeInspectorCollection=[];this._relatedTablesInfo={};this.currentFeature=null;this.geometryChanged=!1;this.currentLayerInfo=null;this.map.infoWindow.hide();0<this.viewedLayerDetails.length&&(this.loading.show(),a=this._getLayerInfoByID(this.viewedLayerDetails.shift()),b=this.viewedFeatureDetails.shift(),this._traverseToSelectedFeature(a,b))},_clearLayerSelection:function(){this._attributeInspectorCollection&&
0<this._attributeInspectorCollection.length&&g.forEach(this._attributeInspectorCollection,function(a){a&&(a.layerInfos&&g.forEach(a.layerInfos,function(a){a=a.featureLayer;a.clearSelection();a.refresh()}),a.destroy())});this.attrInspector&&(this.attrInspector.layerInfos&&g.forEach(this.attrInspector.layerInfos,function(a){a=a.featureLayer;a.clearSelection();a.refresh()}),this.attrInspector.destroy())},_traverseToSelectedFeature:function(a,b){var c=new z;if(0<this.viewedFeatureDetails.length){var d=
this.viewedFeatureDetails[0];this.viewedLayerDetails[0]===this.viewedLayerDetails[1]&&(d=this.viewedFeatureDetails[1])}this._createAttributeInspector([a],!1,null,c,d);b&&ya.getInstance().setSelection(a.featureLayer,b).then(e.hitch(this,function(){this.updateFeatures=a.featureLayer.getSelectedFeatures();0<this.updateFeatures.length&&this._showTemplate(!1)}));c.then(e.hitch(this,function(){if(0<this.viewedLayerDetails.length){var a=this.viewedLayerDetails.shift();this.viewedFeatureDetails.shift();0<
this.viewedLayerDetails.length&&this.viewedLayerDetails[0]===a&&(this.viewedLayerDetails.shift(),this.viewedFeatureDetails.shift());(a=n("[layerid='"+a+"']",this.contentWrapper)[0])&&a.click()}0===this.viewedLayerDetails.length&&this.loading.hide()}))},_getFeatureIndexToSelect:function(a){var b=-1;var c=a.attributes[a._layer.objectIdField];g.some(this.attrInspector._selection,e.hitch(this,function(a,h){if(a.attributes[a._layer.objectIdField]===c)return b=h,!0}));return b},beginEditingByFeatures:function(a,
b,c,d){this.cacheLayer&&this.cacheLayer.clear();this.viewedLayerDetails=c;this.viewedFeatureDetails=d;b&&a&&0!==a.length&&this._createOverDef.then(e.hitch(this,function(){this.feature_action_select(a,b)}))},onReceiveData:function(a,b,c,d){this.config.editor&&this.config.editor.hasOwnProperty("listenToGF")&&!0===this.config.editor.listenToGF&&"GroupFilter"===a&&c.message.hasOwnProperty("fields")&&c.message.hasOwnProperty("values")&&g.forEach(c.message.fields,function(a){this._setPresetValueValue(a,
c.message.values[0])},this)},_setTheme:function(){var a;if("DartTheme"===this.appConfig.theme.name)S.loadStyleLink("dartOverrideCSS",this.folderUrl+"/css/dartTheme.css",null);else if(a=document.getElementById("dartOverrideCSS"))a.disabled=!0;if("LaunchpadTheme"===this.appConfig.theme.name)S.loadStyleLink("launchpadOverrideCSS",this.folderUrl+"/css/launchpadTheme.css",null);else if(a=document.getElementById("launchpadOverrideCSS"))a.disabled=!0;if("DashboardTheme"===this.appConfig.theme.name)S.loadStyleLink("dashboardOverrideCSS",
this.folderUrl+"/css/dashboardTheme.css",null);else if(a=document.getElementById("dashboardOverrideCSS"))a.disabled=!0},_mapClickHandler:function(a){if(!0===a&&!1===this._attrInspIsCurrentlyDisplayed){if(this.map.setInfoWindowOnClick(!1),void 0===this._mapClick||null===this._mapClick)this._mapClick=r(this.map,"click",e.hitch(this,this._onMapClick))}else!0===a&&!0===this._attrInspIsCurrentlyDisplayed?(this._mapClick&&(this._mapClick.remove(),this._mapClick=null),this.map.setInfoWindowOnClick(!0)):
(this._mapClick&&(this._mapClick.remove(),this._mapClick=null),this.map.setInfoWindowOnClick(!0),this.drawToolbar&&this.drawToolbar.deactivate())},destroy:function(){this.inherited(arguments);this.attrInspector&&this.attrInspector.destroy();this.attrInspector=null;this.templatePicker&&this.templatePicker.destroy();this.templatePicker=null;this.currentDrawType&&(this.currentDrawType=null);if(null!==this._menus&&void 0!==this._menus){for(var a in G)this._menus.hasOwnProperty(a)&&null!==this._menus[a]&&
void 0!==this._menus[a]&&this._menus[a].destroyRecursive(!1);this._menus={}}null!==this.drawingTool&&void 0!==this.drawingTool&&(this.drawingTool.destroyRecursive(!1),this.drawingTool=null);this._enableFeatureReduction();this.inherited(arguments)},onActive:function(){if(!0===this._userHasPrivilege&&(f.contains(this.widgetActiveIndicator,"widgetNotActive")&&f.remove(this.widgetActiveIndicator,"widgetNotActive"),f.add(this.widgetActiveIndicator,"widgetActive"),this.map&&(this._disableFeatureReduction(),
this.templatePicker&&this.templatePicker.update(),this._mapClickHandler(!0),this._disconnectLayerSelectionClearedOutside(),!1===this._attrInspIsCurrentlyDisplayed))){var a=null;this.drawingTool&&this.currentDrawType&&(a=this.currentDrawType);this._activateTemplateToolbar(a)}},_enableFeatureReduction:function(){!1===this.clusterState&&(g.forEach(this.featureReductionEnabledLayers,function(a){a.isFeatureReductionEnabled()||a.enableFeatureReduction()}),g.forEach(this.rendererDifferentLayers,function(a){a._layerRenderer&&
(a.setRenderer(a._layerRenderer),a.redraw())}),this.clusterState=!0)},_disableFeatureReduction:function(){!0===this.clusterState&&(g.forEach(this.featureReductionEnabledLayers,function(a){a.isFeatureReductionEnabled()&&a.disableFeatureReduction()}),g.forEach(this.rendererDifferentLayers,function(a){a._serviceRendererJson&&(a.setRenderer(wa.fromJson(a._serviceRendererJson)),a.redraw())}),this.clusterState=!1)},_handleLayerSelectionClear:function(a){a&&a.layerInfos&&g.forEach(a.layerInfos,e.hitch(this,
function(a){a.featureLayer&&(a=r(a.featureLayer,"selection-clear",e.hitch(this,this._onLayerSelectionCleared)),this.own(a),this._layerClearSelectionHandles.push(a))}))},_onLayerSelectionCleared:function(){this._LayerSelectionClearedTimer&&clearTimeout(this._LayerSelectionClearedTimer);this._LayerSelectionClearedTimer=setTimeout(e.hitch(this,function(){this._layerChangedOutside||(this._layerChangedOutside=!0,this._navigateToMain())}),100)},_navigateToMain:function(){this._attrInspIsCurrentlyDisplayed=
!1;this._showTemplatePicker();this._traversal=[];this._nodesCollection=[];this._paginationNodeCollection=[];this._buttonsWrapper=[];this._attributeInspectorCollection=[];this._relatedTablesInfo={};this.currentFeature=null;this.geometryChanged=!1;this.currentLayerInfo=null},_connectLayerSelectionClearedOutside:function(){this._layerChangedOutside=!1;this._disconnectLayerSelectionClearedOutside();this._attrInspIsCurrentlyDisplayed&&(this._attributeInspectorCollection&&0<this._attributeInspectorCollection.length&&
g.forEach(this._attributeInspectorCollection,e.hitch(this,function(a){a&&this._handleLayerSelectionClear(a)})),this.attrInspector&&this._handleLayerSelectionClear(this.attrInspector))},_disconnectLayerSelectionClearedOutside:function(){this._layerClearSelectionHandles&&0<this._layerClearSelectionHandles.length&&g.forEach(this._layerClearSelectionHandles,e.hitch(this,function(a){a.remove()}));this._layerClearSelectionHandles=[]},onDeActive:function(){f.contains(this.widgetActiveIndicator,"widgetActive")&&
f.remove(this.widgetActiveIndicator,"widgetActive");f.add(this.widgetActiveIndicator,"widgetNotActive");this.map&&this._mapClickHandler(!1);this._enableFeatureReduction();this._connectLayerSelectionClearedOutside()},onOpen:function(){!0===this._userHasPrivilege&&(this._workBeforeCreate(),this.widgetManager.activateWidget(this));this.templatePicker&&this.templatePicker.update();N.getInstance().closePanel(this.appConfig.widgetPool.widgets[3].id+"_panel");N.getInstance().closePanel(this.appConfig.widgetPool.widgets[2].id+
"_panel")},_getTableInfos:function(){var a=[],b=this._jimuLayerInfos.getTableInfoArray();g.forEach(b,function(b){a.push(b.getLayerObject())},this);return K(a)},_initControl:function(a){this._userHasPrivilege=!0;this._jimuLayerInfos=a;this._getTableInfos();this.addressUtils=new Da({config:this.config});this._intersectionUtils=new Ea({_jimuLayerInfos:this._jimuLayerInfos,map:this.map});a=!1;this.config.editor&&this.config.editor.layerInfos&&(a=0<this.config.editor.layerInfos.length);this.config.editor.configInfos=
w.getConfigInfos(this._jimuLayerInfos,this.config.editor.layerInfos,!1,a);!1===a&&g.forEach(this.config.editor.configInfos,function(a){a._editFlag=!0});if(void 0===this.config.editor.configInfos||null===this.config.editor.configInfos||0===this.config.editor.configInfos.length)return!1;this._processConfig();g.forEach(this.config.editor.configInfos,function(a){a.featureLayer.name=a.layerInfo.title;a=a.featureLayer;var b=a.renderer,d=b.toJson(),h=p.parse(a._json).drawingInfo.renderer;a._layerRenderer=
b;a._serviceRendererJson=h;a.hasFeatureReduction&&a.hasFeatureReduction()?this.featureReductionEnabledLayers.push(a):d.hasOwnProperty("type")&&"heatmap"==d.type&&this.rendererDifferentLayers.push(a)},this);this._disableFeatureReduction();this.config.editor.hasOwnProperty("autoSaveEdits")?this.config.editor.autoSaveEdits&&((this._autoSaveRuntime=this.config.editor.autoSaveEdits)?M.byId("autoSaveSwitch").set("checked",!0):M.byId("autoSaveSwitch").set("checked",!1)):this.config.editor.autoSaveEdits=
!1;this._createEditor();this.fetchDataByName("GroupFilter");this.widgetManager.activateWidget(this);this._createOverDef.resolve();return!0},_addFilterEditor:function(a){!0===this.config.editor.useFilterEditor&&this.templatePicker&&(this._filterEditor?this._filterEditor.setTemplatePicker(this.templatePicker,a):(this._filterEditorNode=k.create("div",{}),this.templatePickerDiv.insertBefore(this._filterEditorNode,this.templatePicker.domNode),this._filterEditor=new za({_templatePicker:this.templatePicker,
_layers:a,map:this.map,nls:this.nls},this._filterEditorNode)))},_activateEditToolbar:function(a){var b=a.getLayer();0!==this.editToolbar.getCurrentState().tool&&this.editToolbar.deactivate();switch(b.geometryType){case "esriGeometryPoint":this.editToolbar.activate(I.MOVE,a);break;case "esriGeometryPolyline":case "esriGeometryPolygon":this.editToolbar.activate(I.EDIT_VERTICES|I.MOVE|I.ROTATE|I.SCALE,a)}},_polygonToPolyline:function(a){var b=new ka;g.forEach(a.rings,function(a){b.addPath(a)});b.spatialReference=
a.spatialReference;return b},_addRelatedFeatureToLocalLayer:function(a,b){var c,d=null;this.attrInspector&&this.attrInspector._attachmentUploader&&null!==this.attrInspector._attachmentUploader&&this.attrInspector._attachmentUploader.clear();this._removeLocalLayers();this.cacheLayer=this._cloneLayer(a.featureLayer.layerObject);var h=r(this.cacheLayer,"load",e.hitch(this,function(){h.remove();d=this._getLayerInfoForLocalLayer(this.cacheLayer);c=[d];this._createAttributeInspector([d],!0,a.featureLayer.layerObject,
null,null,b);var q=e.clone(a.attributes);this._usePresetValues&&this._modifyAttributesWithPresetValues(q,c[0]);var l=new Q(null,null,q);l.preEditAttrs=p.parse(p.stringify(l.attributes));this.cacheLayer.applyEdits([l],null,null,e.hitch(this,function(a){var b=new E;b.objectIds=[a[0].objectId];this.cacheLayer.selectFeatures(b,C.SELECTION_NEW,e.hitch(this,function(){this.currentFeature=this.updateFeatures[0]=l;this.getConfigDefaults();this.geometryChanged=!1;this._attributeInspectorTools&&this._attributeInspectorTools.triggerFormValidation();
var a=this.currentFeature.getLayer();this.currentLayerInfo=this._getLayerInfoByID(a.id);this.currentLayerInfo.isCache=!0;this._toggleDeleteButton(!1);this._enableAttrInspectorSaveButton(this._validateAttributes(),!0);this._toggleAttrInspectorNavButtons()}))}));this._showTemplate(!1,!1);this.config.editor.hasOwnProperty("autoSaveEdits")&&!0===this._autoSaveRuntime&&setTimeout(e.hitch(this,function(){var a=n(".saveButton",this.buttonHeader)[0];a&&r.emit(a,"click",{cancelable:!0,bubbles:!0})}),100)}))},
_getCopyAttributes:function(a,b){var c=[],d={};var h=new z;var q=new z;c.push(this._intersectionUtils.getDistinctLayers(a,b));c.push(q);Y.getCoordinatesData(b,this.geometryService).then(e.hitch(this,function(a){d.Coordinates=a;this.addressUtils.locateAddress(a.MapSpatialReference).then(function(a){d.Address=a;q.resolve(d)})}));K(c).then(e.hitch(this,function(a){d.Intersection=a[0];h.resolve(d)}));return h.promise},_addGraphicToLocalLayer:function(a){if(void 0!==this.templatePicker&&null!==this.templatePicker&&
this.templatePicker.getSelected()){var b=this.templatePicker.getSelected(),c,d=null;this.attrInspector&&(this.attrInspector._attachmentUploader&&null!==this.attrInspector._attachmentUploader&&this.attrInspector._attachmentUploader.clear(),this.attrInspector.destroy(),this.attrInspector=null);this._removeLocalLayers();this.cacheLayer=this._cloneLayer(this.templatePicker.getSelected().featureLayer);var h=r(this.cacheLayer,"load",e.hitch(this,function(){h.remove();this.cacheLayer.setSelectionSymbol(this._getSelectionSymbol(this.cacheLayer.geometryType,
!0));d=this._getLayerInfoForLocalLayer(this.cacheLayer);c=[d];this._createAttributeInspector([d],!0,this.templatePicker.getSelected().featureLayer);this.config.editor.hasOwnProperty("editGeometryDefault")&&!0===this.config.editor.editGeometryDefault&&setTimeout(e.hitch(this,function(){2>this._traversal.length&&this._editGeomSwitch.set("checked",!0)}),100);var q=e.clone(b.template.prototype.attributes);"esriGeometryPolyline"===this.cacheLayer.geometryType&&"polygon"===a.geometry.type&&(a.geometry=
this._polygonToPolyline(a.geometry));this.loading.show();this._getCopyAttributes(d,a.geometry).then(e.hitch(this,function(b){this._modifyAttributesWithPresetValues(q,c[0],b);this.loading.hide();var d=new Q(a.geometry,null,q);d.preEditAttrs=p.parse(p.stringify(d.attributes));this.cacheLayer.applyEdits([d],null,null,e.hitch(this,function(a){var b=new E;b.objectIds=[a[0].objectId];this.cacheLayer.selectFeatures(b,C.SELECTION_NEW,e.hitch(this,function(){this.currentFeature=this.updateFeatures[0]=d;this.getConfigDefaults();
this.geometryChanged=!1;this._attributeInspectorTools&&this._attributeInspectorTools.triggerFormValidation();var a=this.currentFeature.getLayer();this.currentLayerInfo=this._getLayerInfoByID(a.id);this.currentLayerInfo.isCache=!0;this._toggleDeleteButton(!1);this._enableAttrInspectorSaveButton(this._validateAttributes());(a=n(".esriAttrPaginationDiv",this.domNode))&&a[0]&&m.set(a[0],"display","none")}))}));this._showTemplate(!1,!1);this.config.editor.hasOwnProperty("autoSaveEdits")&&!0===this._autoSaveRuntime&&
setTimeout(e.hitch(this,function(){var a=n(".saveButton",this.buttonHeader)[0];a&&r.emit(a,"click",{cancelable:!0,bubbles:!0})}),100)}))}))}},_cancelEditingFeature:function(a){this.currentFeature&&(a?this._showTemplate(!0,!1):(this.currentFeature.preEditAttrs&&(this.currentFeature.attributes=p.parse(p.stringify(this.currentFeature.preEditAttrs))),this.currentFeature.origGeom&&(this.currentFeature.geometry=U.fromJson(this.currentFeature.origGeom)),this.currentFeature.getLayer().refresh(),this.attrInspector.refresh(),
this._resetEditingVariables()))},_addDateFormat:function(a){a&&a.format&&null!==a.format&&a.format.dateFormat&&null!==a.format.dateFormat&&0<=a.format.dateFormat.toString().toUpperCase().indexOf("TIME")&&(a.format.time=!0)},_processLayerFields:function(a){g.forEach(a,function(a){void 0!==a.domain&&null!==a.domain&&void 0!==a.domain.type&&null!==a.domain.type&&"range"===a.domain.type&&!1===a.domain.hasOwnProperty("range")&&(a.domain.range=[a.domain.minValue,a.domain.maxValue])});return a},_iterateCollection:function(a){return function(b){for(var c=
0;a[c];c++)b(a[c],c)}},_cloneLayer:function(a){var b=this._processLayerFields(a.fields);b={layerDefinition:{id:0,name:a.name+this.nls.editorCache,type:"Feature Layer",displayField:a.displayField,description:"",copyrightText:"",relationships:[],geometryType:a.geometryType,minScale:0,maxScale:0,extent:a.fullExtent,drawingInfo:{renderer:a.renderer,transparency:0,labelingInfo:null},hasAttachments:a.hasAttachments,htmlPopupType:"esriServerHTMLPopupTypeAsHTMLText",objectIdField:a.objectIdField,globalIdField:a.globalIdField,
typeIdField:a.typeIdField,fields:b,types:a.types,templates:a.templates,capabilities:"Create,Delete,Query,Update,Uploads,Editing",editFieldsInfo:void 0===a.editFieldsInfo?null:a.editFieldsInfo}};var c=a.fields.map(function(a){return a.name});this._eventHandler=this.own(r(a,"visibility-change",e.hitch(this,function(){})));b=new C(b,{id:a.id+"_lfl",outFields:c});b.visible=!0;b.renderer=a.renderer;b.originalLayerId=a.id;b._wabProperties={isTemporaryLayer:!0};this.map.addLayer(b);return b},_endsWith:function(a,
b){return-1!==a.indexOf(b,a.length-b.length)},_validateEventHandler:function(){this._enableAttrInspectorSaveButton(this._validateAttributes())},_validateAttributes:function(a){a="undefined"!==typeof a&&null!==a?a:!0;var b=[],c=!0,d=this._validateRequiredFields(),h=this._validateFeatureChanged(),q=[],l=!0;void 0!==this._smartAttributes&&null!==this._smartAttributes&&(q=this._smartAttributes.toggleFields(a));void 0!==this._attributeInspectorTools&&null!==this._attributeInspectorTools&&(l=this._attributeInspectorTools.formValid());
h&&this.currentLayerInfo&&this.currentLayerInfo.attachmentValidations&&(g.forEach(this.currentLayerInfo.attachmentValidations.Actions,e.hitch(this,function(a){var c={};a.filter&&this._smartAttributes&&(c.actionType=a.actionName,c.result=this._smartAttributes.processFilter(a.filter),b.push(c))})),this.attrInspector._attachmentUploader?c=this.performAction(this.attrInspector._attachmentUploader,b,!0):this.attrInspector._attachmentEditor&&(c=this.performAction(this.attrInspector._attachmentEditor,b,
!1)));return w.isObjectEmpty(d)&&0===q.length&&l&&h&&c},performAction:function(a,b,c){var d=!0;m.set(this.attrInspector.attachmentsRequiredMsg,"display","none");g.some(b,e.hitch(this,function(b){switch(b.actionType){case "Hide":if(b.result)return this.currentAction=b.actionType,a.currentAction=b.actionType,m.set(a.domNode,"display","none"),!0;m.set(a.domNode,"display","block");break;case "Disabled":if(b.result)return this.currentAction=b.actionType,a.currentAction=b.actionType,c?m.set(a.domNode,"display",
"none"):this._disableAttachments(a,!0,c),!0;this._disableAttachments(a,!1,c);m.set(a.domNode,"display","block");break;case "Required":if(b.result)return this.currentAction=b.actionType,a.currentAction=b.actionType,m.set(a.domNode,"display","block"),this._hasAddedAnyAttachments(a,c)?(d=!0,m.set(this.attrInspector.attachmentsRequiredMsg,"display","none")):(d=!1,m.set(this.attrInspector.attachmentsRequiredMsg,"display","block")),!0;this.currentAction=null;a.currentAction=null}}));return d},_disableAttachments:function(a,
b,c){var d=b?"none":"block";c||(b=this.attrInspector._attachmentEditor.domNode,n(".attwarning",b)[0]&&m.set(n(".attwarning",b)[0],"display",d),m.set(a._uploadForm,"display",d),g.forEach(a._attachmentList.childNodes,e.hitch(this,function(a){"#text"!==a.nodeName&&(a=n(".deleteAttachment",a)[0])&&m.set(a,"display",d)})))},_hasAddedAnyAttachments:function(a,b){var c=!1;if(!b)return 0<a._attachmentList.childNodes.length&&"#text"!==a._attachmentList.childNodes[0].nodeName?!0:!1;for(var d=0;d<a._attachmentList.childNodes.length;d++)if(a._attachmentList.childNodes[d].childNodes&&
0<a._attachmentList.childNodes[d].childNodes.length&&a._attachmentList.childNodes[d].childNodes[1].value&&0<a._attachmentList.childNodes[d].childNodes[1].value.length){c=!0;break}return c},_toggleEditGeoSwitch:function(a){var b=!1;void 0===this._editGeomSwitch||null===this._editGeomSwitch||1<this._traversal.length||(!1===a&&this.currentLayerInfo.featureLayer.visibleAtMapScale?this.currentLayerInfo&&this.currentLayerInfo._editFlag?(u.style(this._editGeomSwitch.domNode.parentNode,"display","block"),
b=!0):(u.style(this._editGeomSwitch.domNode.parentNode,"display","none"),b=!1):(u.style(this._editGeomSwitch.domNode.parentNode,"display","none"),b=!1),this._turnEditGeometryToggleOff(),setTimeout(e.hitch(this,function(){this._toggleAttributeButtonVisibility(b);this._toggleLocateButtonVisibility(b);this._toggleXYCoordinatesButtonVisibility(b);this._toggleMapNavigationButtonVisibility(b)}),500))},_recordLoadeAttInspector:function(){this.getConfigDefaults()},editGeoCheckChange:function(){return function(){this._editGeometry(this._editGeomSwitch.checked)}},
_attributeInspectorChangeRecord:function(a){this._validateFeatureChanged()&&this.currentFeature||this._postFeatureSave(a);this._recordLoadeAttInspector()},_addWarning:function(){if(0===n(".attwarning",this.attrInspector.domNode).length){var a=k.create("div",{"class":"attwarning"});a.innerHTML=this.nls.attachmentSaveDeleteWarning;void 0!==this.attrInspector._attachmentEditor&&null!==this.attrInspector._attachmentEditor&&this.attrInspector._attachmentEditor.domNode.appendChild(a)}},_hasAnyEditableLayerInRelation:function(a){var b=
!1;g.forEach(a,e.hitch(this,function(a){if(b)return!0;!0===a._editFlag?b=!0:a.relationshipInfos&&0<a.relationshipInfos.length&&(b=this._hasAnyEditableLayerInRelation(a.relationshipInfos))}));return b},_processRelationAndShowAttrInspector:function(a,b,c,d,h,q){var l;this.contentWrapper&&this.contentWrapper.parentNode&&!f.contains(this.contentWrapper,"hidden")&&(this.contentWrapper.parentNode.removeChild(this.contentWrapper),this.navButtonsDiv&&this.navButtonsDiv.parentNode&&this.navButtonsDiv.parentNode.removeChild(this.navButtonsDiv));
this.contentWrapper=k.create("div",{"class":"detailsContainer"},this.mainContainer);q||(this.navButtonsDiv=k.create("div",{"class":"esriAttributeInspector esriAttrPaginationDiv"}),k.place(this.attrInspector.navButtons,this.navButtonsDiv,"first"),k.place(this.navButtonsDiv,this.mainContainer,"before"));var v=k.create("div",{"class":"esriCTItemListContainer"},this.contentWrapper);b&&b.feature&&(c=b.feature._layer,this.currentFeature&&c.id===this.currentFeature._layer.id&&this.currentFeature.setSymbol(this._getSelectionSymbol(this.currentFeature.getLayer().geometryType,
!1)),this.currentFeature=b.feature,this.currentFeature.preEditAttrs=p.parse(p.stringify(this.currentFeature.attributes)),this.currentLayerInfo=this._getLayerInfoByID(c.id),this.currentFeature.setSymbol(this._getSelectionSymbol(this.currentFeature.getLayer().geometryType,!0)),this._toggleDeleteButton(this.attrInspector._currentLInfo.allowDelete),this.loading.show(),setTimeout(e.hitch(this,function(){!this.attrInspector._attachmentEditor||this.currentLayerInfo.isEditable&&this.currentLayerInfo._editFlag||
this._disableAttachments(this.attrInspector._attachmentEditor,!0,!1);this.loading.hide()}),2E3),setTimeout(e.hitch(this,function(){this.config.editor.hasOwnProperty("editGeometryDefault")&&!0===this.config.editor.editGeometryDefault&&2>this._traversal.length&&this.currentFeature&&this.currentFeature.geometry&&(this.currentFeature.origGeom=this.currentFeature.geometry.toJson(),!this.currentLayerInfo.disableGeometryUpdate&&this.currentLayerInfo.featureLayer.visibleAtMapScale&&this.currentLayerInfo.configFeatureLayer.layerAllowsUpdate&&
(!this.currentLayerInfo.featureLayer.hasZ||this.currentLayerInfo.featureLayer.hasZ&&this.currentLayerInfo.featureLayer.enableZDefaults)&&(!this.currentLayerInfo.featureLayer.hasM||this.currentLayerInfo.featureLayer.hasM&&this.currentLayerInfo.featureLayer.allowUpdateWithoutMValues)?this._activateEditToolbar(this.currentFeature):0!==this.editToolbar.getCurrentState().tool&&(this.editToolbar.deactivate(),this._editingEnabled=!1))}),1E3));c&&(l=this.addItem(c.name,!0,v,c.id,q,c));if(a&&b.feature){0<
this._traversal.length?this._traversal[this._traversal.length-1]=b.feature._layer.id:this._traversal.push(b.feature._layer.id);c=this._getRelationshipInfo(b.feature);a={attributes:e.clone(b.feature.attributes),_layer:b.feature._layer};if(h){var B=[];g.forEach(h,function(a){B.push(a.attributes[a._layer.objectIdField])})}if(c&&0<c.length){var H=[];g.forEach(c,e.hitch(this,function(a){var b=a._editFlag;!a._editFlag&&a.relationshipInfos&&0<a.relationshipInfos.length&&(b=this._hasAnyEditableLayerInRelation(a.relationshipInfos));
b&&a.featureLayer&&a.hasOwnProperty("relationshipId")&&H.push(a)}));0<H.length?((h=n(".esriCTItemContent",v))&&h[0]&&f.remove(h[0],"esriCTRelatedItemContent"),this._relatedTablesInfo[b.feature._layer.id]={},this._relatedTablesInfo[b.feature._layer.id]=new pa({relationshipInfo:H,layerInfosObj:this._jimuLayerInfos,parentFeature:a,parentFeatureIndexInAI:this.attrInspector._featureIdx,parentFieldInfos:this.currentLayerInfo.fieldInfos,config:this.config,nls:this.nls,mapSpatialReference:this.map.spatialReference},
k.create("div")),this.own(r(this._relatedTablesInfo[b.feature._layer.id],"addRelatedRecord",e.hitch(this,function(a,b,c,d,h){f.add(this.contentWrapper,"hidden");f.add(this.buttonHeader,"hidden");m.set(this.navButtonsDiv,"display","none");this.attrInspector.ctStoredFeatureIndex=d;this._attributeInspectorCollection.push(this.attrInspector);this._nodesCollection.push(this.contentWrapper);this._buttonsWrapper.push(this.buttonHeader);this._paginationNodeCollection.push(this.navButtonsDiv);this._traversal.push(c);
this.currentRelatedDom=b;this._addRelatedFeatureToLocalLayer(a,h);this._addingNewRelatedRecord=!0}))),this.own(r(this._relatedTablesInfo[b.feature._layer.id],"titleClicked",e.hitch(this,function(a,c,d,h,l,q){this.addNewRelatedRecord&&(d=!0,this.addNewRelatedRecord=!1);this._editGeomSwitch.set("checked",!1);!d&&this.currentFeature&&this.config.editor.displayPromptOnSave&&this._validateFeatureChanged()?this._promptToResolvePendingEdit(!1,null,!0).then(e.hitch(this,function(){this._fetchRelatedRecords(d,
b.feature._layer,c,a,l,h,B,q);B=null}),function(){}):(this._fetchRelatedRecords(d,b.feature._layer,c,a,l,h,B,q),B=null)}))),this.own(r(this._relatedTablesInfo[b.feature._layer.id],"addRelatedItemContent",e.hitch(this,function(a){a?this.addItem(this.nls.relatedItemTitle,!1,v,null,!1):(a=n(".esriCTItemContent",v))&&a[0]&&f.add(a[0],"esriCTRelatedItemContent")}))),this._relatedTablesInfo[b.feature._layer.id].startup()):this._disableToggling(l)}else this._disableToggling(l)}d&&d.resolve()},_checkValidRelationShips:function(a,
b){g.forEach(a,e.hitch(this,function(a){a.featureLayer&&a.hasOwnProperty("relationshipId")&&g.some(b.relationships,e.hitch(this,function(a){}))}))},_fetchRelatedRecords:function(a,b,c,d,h,q,l,g){this._getRelatedRecordsByRelatedQuery(b,c,d,h).then(e.hitch(this,function(b){if(b&&0===b.length)a&&(f.remove(this.contentWrapper,"hidden"),this.attrInspector.refresh(),setTimeout(e.hitch(this,function(){m.set(this.attrInspector.navButtons,"display",!this.attrInspector._hideNavButtons&&1<this.attrInspector._numFeatures?
"":"none");this.attrInspector.navMessage.innerHTML=O.substitute({idx:this.attrInspector._featureIdx+1,of:this.attrInspector.NLS_of,numFeatures:this.attrInspector._numFeatures},this.attrInspector._navMessage);this.currentFeature=this.attrInspector._numFeatures?this.attrInspector._selection[this.attrInspector._featureIdx]:null;this.currentFeature.preEditAttrs=p.parse(p.stringify(this.currentFeature.attributes))}),200));else if(f.add(this.contentWrapper,"hidden"),m.set(this.navButtonsDiv,"display","none"),
this.attrInspector.ctStoredFeatureIndex=q,this._attributeInspectorCollection.push(this.attrInspector),this._nodesCollection.push(this.contentWrapper),this._buttonsWrapper.push(this.buttonHeader),this._paginationNodeCollection.push(this.navButtonsDiv),this._traversal.push(d),l&&(b=[],b=l,l=null),b&&0<b.length){var c=new E;c.objectIds=b;if(0<this.viewedLayerDetails.length){var h=new z;b=this.viewedFeatureDetails[0];this.viewedLayerDetails[0]===this.viewedLayerDetails[1]&&(b=this.viewedFeatureDetails[1]);
this._createAttributeInspector([this._getLayerInfoByID(d)],!1,null,h,b,g)}else this._createAttributeInspector([this._getLayerInfoByID(d)],!1,null,null,null,g);b=this._jimuLayerInfos.getLayerOrTableInfoById(d).layerObject;this.loading.show();b.selectFeatures(c,C.SELECTION_NEW,e.hitch(this,function(b){if(this._addingNewRelatedRecord&&this._processBackButtonInNewRelatedRecord||a)this.currentFeature=null;this.updateFeatures=b;a?this.attrInspector.last():this.attrInspector.first();this.currentFeature=
this.attrInspector._numFeatures?this.attrInspector._selection[this.attrInspector._featureIdx]:null;this.currentFeature.preEditAttrs=p.parse(p.stringify(this.currentFeature.attributes));0<this.updateFeatures.length&&this._showTemplate(!1);this._addingNewRelatedRecord&&this._processBackButtonInNewRelatedRecord&&(this._processBackButtonInNewRelatedRecord=this._addingNewRelatedRecord=!1,this._onCancelButtonClicked());this.loading.hide()}),e.hitch(this,function(){this.loading.hide()}));h&&h.then(e.hitch(this,
function(){if(0<this.viewedLayerDetails.length){var a=this.viewedLayerDetails.shift();this.viewedFeatureDetails.shift();0<this.viewedLayerDetails.length&&this.viewedLayerDetails[0]===a&&(this.viewedLayerDetails.shift(),this.viewedFeatureDetails.shift());n("[layerid='"+a+"']",this.contentWrapper)[0].click()}0===this.viewedLayerDetails.length&&this.loading.hide()}))}}))},_createAttributeInspector:function(a,b,c,d,h,q){if(2>this._traversal.length&&(this._editGeomSwitch&&(this._editGeomSwitch.destroy(),
this._editGeomSwitch=null),this.editSwitchDiv))for(;this.editSwitchDiv.firstChild;)this.editSwitchDiv.removeChild(this.editSwitchDiv.firstChild);this._setCancelButtonText();q&&g.forEach(a[0].fieldInfos,e.hitch(this,function(a){a.name===q&&(a.isEditable=!1)}));this.attrInspector=w.ATI({layerInfos:a},ca.create("div",{style:{width:"100%",height:"100%"}}));this.attrInspector.startup();k.place(this.attrInspector.navMessage,this.attrInspector.nextFeatureButton.domNode,"before");if(2>this._traversal.length){this.editSwitchDiv=
k.create("div");this.editSwitchDiv.appendChild(k.create("div",{"class":"spacer"}));this._editGeomSwitch=new qa({id:"editGeometrySwitch_"+this.attrInspector.id,checked:!1,value:this.nls.editGeometry},null);this.editSwitchDiv.appendChild(this._editGeomSwitch.domNode);k.place(e.replace("<label for='editGeometrySwitch_'"+this.attrInspector.id+">{replace}</label></br></br>",{replace:this.nls.editGeometry}),this._editGeomSwitch.domNode,"after");k.place(this.editSwitchDiv,this.attrInspector.deleteBtn.domNode,
"before");this.own(r(this._editGeomSwitch,"Change",e.hitch(this,this.editGeoCheckChange())));this._xyCoordinates=k.create("div",{"class":"esriCTXYCoordinates esriCTGeometryEditor hidden",title:this.nls.moveSelectedFeatureToXY},this.attrInspector.deleteBtn.domNode,"after");this.own(r(this._xyCoordinates,"click",e.hitch(this,function(){this._createCoordinatesPopup()})));this._locateButtonDiv=k.create("div",{"class":"esriCTLocateButtonContainer esriCTGeometryEditor hidden",title:this.nls.moveSelectedFeatureToGPS},
this.attrInspector.deleteBtn.domNode,"after");this._locateButton=new Fa({map:this.map,highlightLocation:!1,setScale:!1,centerAt:!0},k.create("div"));this._locateButton.startup();var l=this._locateButton.domNode.style.display;"none"===l&&m.set(this._locateButtonDiv,"display",l);this.own(r(this._locateButton,"locate",e.hitch(this,function(a){a.error&&a.error.message?F({message:a.error.message}):a&&a.graphic&&a.graphic.geometry&&(this.currentFeature.setGeometry(a.graphic.geometry),this.geometryEdited())})));
this.own(r(this._locateButtonDiv,"click",e.hitch(this,function(){this._locateButton.locate()})));this._mapNavigation=k.create("div",{"class":"esriCTMapNavigationLocked esriCTGeometryEditor hidden",title:this.nls.mapNavigationLocked},this.attrInspector.deleteBtn.domNode,"after");this.own(r(this._mapNavigation,"click",e.hitch(this,this._toggleMapNavigationButtonState)));if(this.config.editor.enableAttributeUpdates){var v="refreshAttributes";var B=this.nls.refreshAttributes}this.config.editor.enableAutomaticAttributeUpdates&&
(v="esriCTAutoUpdateOnMode",B=this.nls.automaticAttributeUpdatesOn);this._refreshButton=k.create("div",{"class":v+" esriCTGeometryEditor hidden",title:B},this.attrInspector.deleteBtn.domNode,"after");this.own(r(this._refreshButton,"click",e.hitch(this,function(){this.config.editor.enableAutomaticAttributeUpdates?this._toggleAttributeButtonState():this._refreshAttributes()})))}k.create("div",{innerHTML:"<br><b>Validation Code</b>: <input id='vc' style='border: 1px solid black;'>","class":"dijitReset dijitInputField dijitInputContainer"},
this.attrInspector.deleteBtn.domNode,"before");k.create("div",{innerHTML:this.nls.save,"class":"saveButton jimu-btn jimu-state-disabled",style:"visibility: hidden"},this.attrInspector.deleteBtn.domNode,"after");this.buttonHeader&&f.add(this.buttonHeader,"hidden");this.buttonHeader=k.create("div",{"class":"buttonHeader"},this.buttonWrapper);v=k.create("div",{innerHTML:this.nls.save,"class":"saveButton jimu-btn jimu-state-disabled"},this.buttonHeader,"last");m.set(this.attrInspector.deleteBtn.domNode,
"display","none");1>n(".deleteButton",this.buttonHeader).length&&(B=k.create("div",{innerHTML:this.nls.deleteText,"class":"deleteButton jimu-btn jimu-btn-vacation"},v,"before"),r(B,"click",e.hitch(this,function(){this.map.infoWindow.isShowing&&this.map.infoWindow.hide();this.config.editor.displayPromptOnDelete?this._promptToDelete():this._deleteFeature()})));this.config.editor.showActionButtonsAbove?m.set(this.mainContainer,"margin-top","5px"):(k.place(this.buttonWrapper,this.mainContainer,"after"),
m.set(this.mainContainer,"margin-bottom","5px"),m.set(this.mainContainer,"margin-top","0px"));this.own(r(v,"click",e.hitch(this,function(){this._validateFeatureChanged()?(this.map.infoWindow.isShowing&&this.map.infoWindow.hide(),this._saveEdit(this.currentFeature)):this._resetEditingVariables()})));J.after(this.attrInspector,"onLayerSelectionChange",e.hitch(this,function(){"active"!==this.state&&(this._LayerSelectionChangedTimer&&clearTimeout(this._LayerSelectionChangedTimer),this._LayerSelectionChangedTimer=
setTimeout(e.hitch(this,function(){this.attrInspector&&this.attrInspector.first()}),500))}));this.attrInspector._attachmentEditor&&(J.after(this.attrInspector._attachmentEditor,"_onDeleteAttachmentComplete",e.hitch(this,function(){this._hasAddedAnyAttachments(this.attrInspector._attachmentEditor,!1)||"Required"!==this.currentAction||m.set(this.attrInspector.attachmentsRequiredMsg,"display","block");this._enableAttrInspectorSaveButton(this._validateAttributes())})),J.after(this.attrInspector._attachmentEditor,
"_onAddAttachmentComplete",e.hitch(this,function(){"block"===m.get(this.attrInspector.attachmentsRequiredMsg,"display")&&m.set(this.attrInspector.attachmentsRequiredMsg,"display","none");this._enableAttrInspectorSaveButton(this._validateAttributes())})),J.after(this.attrInspector._attachmentEditor,"_getAttachments",e.hitch(this,function(){this.attachmentloading.show();setTimeout(e.hitch(this,function(){if(this.currentLayerInfo&&this.currentLayerInfo.attachmentValidations){if(this.currentLayerInfo.attachmentValidations){var a=
[];g.forEach(this.currentLayerInfo.attachmentValidations.Actions,e.hitch(this,function(b){var c={};b.filter&&this._smartAttributes&&(c.actionType=b.actionName,c.result=this._smartAttributes.processFilter(b.filter),a.push(c))}));this.attrInspector._attachmentUploader?this.performAction(this.attrInspector._attachmentUploader,a,!0):this.performAction(this.attrInspector._attachmentEditor,a,!1)}!this.attrInspector._attachmentEditor||this.currentLayerInfo.isEditable&&this.currentLayerInfo._editFlag||this._disableAttachments(this.attrInspector._attachmentEditor,
!0,!1)}this.attachmentloading.hide()}),1500)})));this.own(r(this.attrInspector,"attribute-change",e.hitch(this,function(a){this.currentFeature&&(this.currentFeature.attributes[a.fieldName]=a.fieldValue,this._enableAttrInspectorSaveButton(this._validateAttributes()))})));this.own(r(this.attrInspector,"next",e.hitch(this,function(a){this.currentFeature&&this.config.editor.displayPromptOnSave&&this._validateFeatureChanged()?this._promptToResolvePendingEdit(!1,null,!1).then(e.hitch(this,function(){this._processNextButtonClicked(!0,
a,null,d,h)}),function(){}):(this.currentFeature&&(this.currentFeature.preEditAttrs&&(this.currentFeature.attributes=p.parse(p.stringify(this.currentFeature.preEditAttrs))),this.currentFeature.origGeom&&(this.currentFeature.geometry=U.fromJson(this.currentFeature.origGeom))),this._processNextButtonClicked(!0,a,null,d,h))})));this.attrInspector.attachmentsRequiredMsg=k.create("div",{innerHTML:this.nls.attachmentsRequiredMsg,style:"display:none;color:red;margin-top:5px"});1===a.length&&a[0].featureLayer.hasOwnProperty("originalLayerId")&&
!0===this._getLayerInfoByID(a[0].featureLayer.originalLayerId).featureLayer.hasAttachments&&(a=k.create("div"),k.place(a,this.attrInspector.attributeTable,"after"),this.attrInspector._attachmentUploader=new va({"class":"atiAttachmentEditor",attachmentsRequiredMsg:this.attrInspector.attachmentsRequiredMsg,currentAction:this.currentAction},a),this.attrInspector._attachmentUploader.startup(),r(this.attrInspector._attachmentUploader,"attachmentAdded",e.hitch(this,function(){this._enableAttrInspectorSaveButton(this._validateAttributes())})),
r(this.attrInspector._attachmentUploader,"attachmentDeleted",e.hitch(this,function(){this._enableAttrInspectorSaveButton(this._validateAttributes())})));if(this.attrInspector._attachmentUploader)var H=this.attrInspector._attachmentUploader.domNode;else this.attrInspector._attachmentEditor&&(H=this.attrInspector._attachmentEditor.domNode);H&&k.place(this.attrInspector.attachmentsRequiredMsg,H,"before");b&&this._processRelationAndShowAttrInspector(!1,null,c,null,null,!0)},_processNextButtonClicked:function(a,
b,c,d,h){this._processRelationAndShowAttrInspector(a,b,c,d,h,!1);this._attributeInspectorChangeRecord(b);this._addWarning();this._toggleAttrInspectorNavButtons()},_toggleDeleteButton:function(a){var b=n(".deleteButton",this.buttonHeader);0<b.length&&(b=b[0],b.style.display=!0===a?"block":"none")},_activateTemplateToolbar:function(a){a=a||null;if(this.templatePicker){var b=this.templatePicker.getSelected();if(b&&null!==b){var c=b.featureLayer.geometryType;if(void 0!==b.template&&null!==b.template&&
void 0!==b.template.drawingTool&&null!==b.template.drawingTool)switch(b.template.drawingTool){case "esriFeatureEditToolNone":switch(b.featureLayer.geometryType){case "esriGeometryPoint":a=null!==a?a:t.POINT;break;case "esriGeometryPolyline":a=null!==a?a:t.POLYLINE;break;case "esriGeometryPolygon":a=null!==a?a:t.POLYGON}break;case "esriFeatureEditToolPoint":a=null!==a?a:t.POINT;break;case "esriFeatureEditToolLine":a=null!==a?a:t.POLYLINE;break;case "esriFeatureEditToolAutoCompletePolygon":case "esriFeatureEditToolPolygon":a=
null!==a?a:t.POLYGON;break;case "esriFeatureEditToolCircle":a=null!==a?a:t.CIRCLE;break;case "esriFeatureEditToolEllipse":a=null!==a?a:t.ELLIPSE;break;case "esriFeatureEditToolRectangle":a=null!==a?a:t.RECTANGLE;break;case "esriFeatureEditToolFreehand":switch(b.featureLayer.geometryType){case "esriGeometryPoint":a=null!==a?a:t.POINT;break;case "esriGeometryPolyline":a=null!==a?a:t.FREEHAND_POLYLINE;break;case "esriGeometryPolygon":a=null!==a?a:t.FREEHAND_POLYGON}break;default:switch(b.featureLayer.geometryType){case "esriGeometryPoint":a=
null!==a?a:t.POINT;break;case "esriGeometryPolyline":a=null!==a?a:t.POLYLINE;break;case "esriGeometryPolygon":a=null!==a?a:t.POLYGON}}else switch(b.featureLayer.geometryType){case "esriGeometryPoint":a=null!==a?a:t.POINT;break;case "esriGeometryPolyline":a=null!==a?a:t.POLYLINE;break;case "esriGeometryPolygon":a=null!==a?a:t.POLYGON}this.drawToolbar.activate(a);this._setDrawingToolbar(c,a)}else this.drawToolbar&&(this._setDrawingToolbar("select",null),this.drawToolbar.deactivate())}else this.drawToolbar&&
(this._setDrawingToolbar("select",null),this.drawToolbar.deactivate())},_templatePickerNeedsToBeCreated:function(){return!0},_drawingToolClick:function(a,b){return function(){"select"!==a&&(this.drawingTool.set("label",b.label),this.drawingTool.set("iconClass",b.iconClass),this.drawToolbar.activate(b._drawType),this.currentDrawType=b._drawType,this.currentShapeType=a)}},_menus:{},drawingTool:null,_setDrawingToolbar:function(a,b){null!==this.drawingTool&&void 0!==this.drawingTool&&(null!==this.currentShapeType&&
void 0!==this.currentShapeType&&this.currentShapeType===a||this.drawingTool.set("dropDown",this._menus[a]),this.currentShapeType=a,this.currentDrawType=null,g.some(G[a],function(a){return a._drawType===b||null===b?(this.drawingTool.set("label",a.label),this.drawingTool.set("iconClass",a.iconClass),this.currentDrawType=a._drawType,!0):!1},this),null===this.currentDrawType||void 0===this.currentDrawType)&&(this.drawingTool.set("label",G[a][0].label),this.drawingTool.set("iconClass",G[a][0].iconClass),
this.currentDrawType=G[a][0]._drawType)},_createDrawingToolbar:function(){this.config.editor.hasOwnProperty("displayShapeSelector")?!0===this.config.editor.displayShapeSelector&&(this._menus=this._createDrawingMenus(),this.drawingTool=new sa({label:"",name:"drawingTool",id:"drawingTool"},this.drawingOptionsDiv),this.drawingTool.startup(),this._setDrawingToolbar("select",null)):this.config.editor.displayShapeSelector=!1},_createMenu:function(a){var b=new ta({style:"display: none;"});g.forEach(a,function(c){c=
e.mixin(c,{onClick:e.hitch(this,this._drawingToolClick(a,c))});c=new ua(c);b.addChild(c)},this);b.startup();return b},_createDrawingMenus:function(){var a={},b;for(b in G)a[b]=this._createMenu(G[b]);return a},_createEditor:function(){var a=null;if(void 0!==this.config.editor&&null!==this.config.editor){var b=this._getEditableLayers(this.config.editor.configInfos,!1);if(1>b.length)this._creationDisabledOnAll=!0,this.currentLayerInfo&&!this.currentLayerInfo.isCache&&this._attrInspIsCurrentlyDisplayed&&
!0===this._attrInspIsCurrentlyDisplayed&&(this.attrInspector.refresh(),this.attrInspector.first());else if(this._templatePickerNeedsToBeCreated()){if(this._attrInspIsCurrentlyDisplayed&&!0===this._attrInspIsCurrentlyDisplayed){this._recreateOnNextShow=!0;this.currentLayerInfo.isCache||(this.attrInspector.refresh(),this.attrInspector.first());return}if(this.templatePicker&&null!==this.templatePicker){var c=this.currentDrawType;a=this.templatePicker.getSelected();null===a&&this.drawToolbar&&this.drawToolbar.deactivate();
this._select_change_event.remove();this.templatePicker.destroy();this._resetEditingVariables();this.drawToolbar&&this.drawToolbar.deactivate();this.drawingTool&&this._setDrawingToolbar("select",null)}else this._createAutoSaveSwitch(this.config.editor.autoSaveEdits);this.templatePickerNode=k.create("div",{"class":"eeTemplatePicker"});this.templatePickerDiv.appendChild(this.templatePickerNode);this.templatePicker=new ja({featureLayers:b,"class":"esriTemplatePicker",grouping:!0,maxLabelLength:"25",showTooltip:!1},
this.templatePickerNode);this.templatePicker.startup();this._addFilterEditor(b);if(null!==a&&this.templatePicker){var d=Object.getOwnPropertyNames(this.templatePicker._itemWidgets),h=[];g.forEach(this.templatePicker._flItems,function(a){g.forEach(a,function(a){h.push(a)})});h.length===d.length?!1===g.some(h,function(b,h){if(a.featureLayer.id===b.layer.id&&b.template.name===a.template.name&&b.template.drawingTool===a.template.drawingTool&&b.template.description===a.template.description&&b.type===a.type){var e=
u.byId(d[h]);r.emit(e,"click",{bubbles:!0,cancelable:!0});this._activateTemplateToolbar(c);return!0}},this)&&(this.drawToolbar&&this.drawToolbar.deactivate(),this.drawingTool&&this._setDrawingToolbar("select",null)):(this.drawToolbar&&this.drawToolbar.deactivate(),this.drawingTool&&this._setDrawingToolbar("select",null))}else this.drawToolbar&&this.drawToolbar.deactivate(),this.drawingTool&&this._setDrawingToolbar("select",null);this._select_change_event=r(this.templatePicker,"selection-change",e.hitch(this,
this._template_change));this.own(this._select_change_event)}(this._creationDisabledOnAll=1>b.length?!0:!1)?(this.drawToolbar&&this.drawToolbar.deactivate(),this.drawingTool&&this._setDrawingToolbar("select",null),this.templatePicker&&(u.style(this.templatePicker.domNode,"display","none"),this.config.editor.autoSaveEdits&&this._createAutoSaveSwitch(!1),this._mapClickHandler(!0),this.templatePicker.clearSelection()),this.drawingTool&&u.style(this.drawingTool.domNode,"display","none"),this._filterEditor&&
u.style(this._filterEditor.domNode,"display","none")):(this.templatePicker&&u.style(this.templatePicker.domNode,"display","block"),this.config.editor.autoSaveEdits&&this._createAutoSaveSwitch(!0),this.drawingTool&&u.style(this.drawingTool.domNode,"display","block"),this._filterEditor&&u.style(this._filterEditor.domNode,"display","block"));this.config.editor.configInfos&&!this._isPresetTableCreated&&(this._isPresetTableCreated=!0,this._createPresetTable(this.config.editor.configInfos))}},isGuid:function(a){"{"===
a[0]&&(a=a.substring(1,a.length-1));return/^(\{){0,1}[0-9a-fA-F]{8}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{12}(\}){0,1}$/gi.test(a)},_template_change:function(){this.currentShapeType=this.currentDrawType=null;this._activateTemplateToolbar()},validateGUID:function(a,b){return this.isGuid(a)},_createPresetTable:function(a){this._processConfigForBackwardPresetInfos(a);this.config.editor.hasOwnProperty("presetInfos")&&0<Object.keys(this.config.editor.presetInfos).length?(this._initPresetFieldsTable(),
(a=this._fillPresetValueTable(a))?n(".presetFieldsTableDiv")[0].style.display="block":n(".presetFieldsTableDiv")[0].style.display="none"):n(".presetFieldsTableDiv")[0].style.display="none"},_processConfigForBackwardPresetInfos:function(a){var b=[];!this.config.editor.hasOwnProperty("presetInfos")&&a&&(g.forEach(a,e.hitch(this,function(a){a.fieldValues={};g.forEach(a.fieldInfos,e.hitch(this,function(c){if(c.hasOwnProperty("canPresetValue")&&c.canPresetValue){var d=[{actionName:"Intersection",enabled:!1},
{actionName:"Address",enabled:!1},{actionName:"Coordinates",enabled:!1},{actionName:"Preset",enabled:!0}];a.fieldValues[c.fieldName]=e.clone(d);b[c.fieldName]=[]}}))})),this.config.editor.presetInfos=b)},_presetChange:function(){this._toggleUsePresetValues(!0)},_createAutoSaveSwitch:function(a){a?n(".autoSaveOptionDiv")[0].style.display="block":n(".autoSaveOptionDiv")[0].style.display="none"},_toggleRunTimeAutoSave:function(){this._autoSaveRuntime=!1===this._autoSaveRuntime?!0:!1;this._createAutoSaveSwitch(this.config.editor.autoSaveEdits)},
_deleteFeature:function(){if(this.currentFeature){this._resetEditingVariables();var a=this.currentFeature.getLayer();if(null===a.url)a.clear(),this._showTemplate(!0);else{var b=n(".processing-indicator"),c=n(".processing-indicator-panel"),d=n(".saveButton",this.buttonHeader)[0];g.forEach(b,function(a){f.contains(a,"busy")||f.add(a,"busy")});g.forEach(c,function(a){f.contains(a,"busy")||f.add(a,"busy")});f.contains(d,"hide")||f.add(d,"hide");a.applyEdits(null,null,[this.currentFeature],e.hitch(this,
function(h,q,l){if(l&&0<l.length&&l[0].hasOwnProperty("error"))F({message:l[0].error.toString()});else if(this.updateFeatures.splice(this.updateFeatures.indexOf(this.currentFeature),1),this.updateFeatures&&0<this.updateFeatures.length)if("Table"===a.type){var v=[];this.loading.show();g.forEach(this.updateFeatures,function(b){v.push(b.attributes[a.objectIdField])});h=new E;h.objectIds=v;a.selectFeatures(h,C.SELECTION_NEW,e.hitch(this,function(a){this.updateFeatures=a;this.attrInspector.refresh();this.attrInspector.first();
this.loading.hide()}),e.hitch(this,function(){this.loading.hide()}))}else this.attrInspector.refresh(),this.attrInspector.first();else 2>this._traversal.length?this._showTemplate(!0):r.emit(this.cancelButton,"click",{cancelable:!0,bubbles:!0});g.forEach(b,function(a){f.contains(a,"busy")&&f.remove(a,"busy")});g.forEach(c,function(a){f.contains(a,"busy")&&f.remove(a,"busy")});f.contains(d,"hide")&&f.remove(d,"hide")}),e.hitch(this,function(a){F({message:a.message.toString()+"\n"+a.details});g.forEach(b,
function(a){f.contains(a,"busy")&&f.remove(a,"busy")});g.forEach(c,function(a){f.contains(a,"busy")&&f.remove(a,"busy")});f.contains(d,"hide")&&f.remove(d,"hide")}))}}},_editGeometry:function(a){if(!a||!(this._ignoreEditGeometryToggle||this.currentLayerInfo&&!this.currentLayerInfo._editFlag)){if(!0===a){if(this.currentLayerInfo&&this.currentLayerInfo.disableGeometryUpdate&&!this.currentLayerInfo.isCache||this.currentLayerInfo&&!this.currentLayerInfo.isCache&&(!this.currentLayerInfo.configFeatureLayer.layerAllowsUpdate||
this.currentLayerInfo.featureLayer.hasZ&&!this.currentLayerInfo.featureLayer.enableZDefaults||this.currentLayerInfo.featureLayer.hasM&&!this.currentLayerInfo.featureLayer.allowUpdateWithoutMValues))return;this.map.setInfoWindowOnClick(!1);this.map.infoWindow.isShowing&&this.map.infoWindow.hide();!1===this._editingEnabled&&this.currentFeature&&this.currentFeature.geometry?(this._editingEnabled=!0,this.currentFeature.origGeom=this.currentFeature.geometry.toJson(),this._activateEditToolbar(this.currentFeature)):
(0!==this.editToolbar.getCurrentState().tool&&this.editToolbar.deactivate(),this._editingEnabled=!1)}else this.map.setInfoWindowOnClick(!0),this.editToolbar.deactivate(),this._editingEnabled=!1;this._toggleAttributeButtonVisibility(a);this._toggleLocateButtonVisibility(a);this._toggleXYCoordinatesButtonVisibility(a);this._toggleMapNavigationButtonVisibility(a)}},_toggleAttributeButtonState:function(){this._refreshButton&&f.contains(this._refreshButton,"esriCTAutoUpdateOnMode")?(f.replace(this._refreshButton,
"esriCTAutoUpdateOffMode","esriCTAutoUpdateOnMode"),x.set(this._refreshButton,"title",this.nls.automaticAttributeUpdatesOff)):this._refreshButton&&f.contains(this._refreshButton,"esriCTAutoUpdateOffMode")&&(f.replace(this._refreshButton,"esriCTAutoUpdateOnMode","esriCTAutoUpdateOffMode"),x.set(this._refreshButton,"title",this.nls.automaticAttributeUpdatesOn),this._refreshAttributes())},_toggleAttributeButtonVisibility:function(a){a&&this.config.editor.enableAttributeUpdates?f.remove(this._refreshButton,
"hidden"):f.add(this._refreshButton,"hidden")},_toggleLocateButtonVisibility:function(a){a&&this.config.editor.enableMovingSelectedFeatureToGPS&&this.currentFeature&&this.currentFeature.geometry&&"point"===this.currentFeature.geometry.type?f.remove(this._locateButtonDiv,"hidden"):f.add(this._locateButtonDiv,"hidden")},_toggleXYCoordinatesButtonVisibility:function(a){a&&this.config.editor.enableMovingSelectedFeatureToXY&&this.currentFeature&&this.currentFeature.geometry&&"point"===this.currentFeature.geometry.type?
f.remove(this._xyCoordinates,"hidden"):f.add(this._xyCoordinates,"hidden")},_toggleMapNavigationButtonState:function(){f.contains(this._mapNavigation,"esriCTMapNavigationUnLocked")?this._lockMapNavigation():f.contains(this._mapNavigation,"esriCTMapNavigationLocked")&&this._unLockMapNavigation()},_lockMapNavigation:function(){this._mapNavigation&&(f.replace(this._mapNavigation,"esriCTMapNavigationLocked","esriCTMapNavigationUnLocked"),x.set(this._mapNavigation,"title",this.nls.mapNavigationLocked),
this.map.disableMapNavigation())},_unLockMapNavigation:function(){this._mapNavigation&&(f.replace(this._mapNavigation,"esriCTMapNavigationUnLocked","esriCTMapNavigationLocked"),x.set(this._mapNavigation,"title",this.nls.mapNavigationUnLocked),this.map.enableMapNavigation())},_toggleMapNavigationButtonVisibility:function(a){a&&this.config.editor.enableLockingMapNavigation?f.remove(this._mapNavigation,"hidden"):f.add(this._mapNavigation,"hidden");this._unLockMapNavigation()},_enableAttrInspectorSaveButton:function(a,
b){var c=n(".saveButton",this.buttonHeader)[0],d=!1;c&&(a?(f.contains(c,"jimu-state-disabled")&&f.remove(c,"jimu-state-disabled"),d=!0):f.contains(c,"jimu-state-disabled")||f.add(c,"jimu-state-disabled"),!b&&this.currentFeature&&this._relatedTablesInfo[this.currentFeature._layer.id]&&(this._relatedTablesInfo[this.currentFeature._layer.id].isSaveEnable=d))},_setConfiguredFieldInfos:function(a,b){var c=[];g.forEach(b,function(b){var d=V.getFieldInfoByFieldName(a,b.fieldName);b=e.mixin(e.clone(d),b);
c.push(b)});return c},_getLayerInfoByID:function(a){0<a.indexOf("_lfl")&&(a=a.replace("_lfl",""));if(this._traversal&&0<this._traversal.length){var b=this.config.editor.configInfos;g.some(this._traversal,function(a,c){g.some(b,function(c){if(c.featureLayer.id===a)return b=c,!0});1<this._traversal.length&&c+1<this._traversal.length&&(b=b.relationshipInfos)},this);if(!b.layerInfo){b.layerInfo=this._jimuLayerInfos.getLayerOrTableInfoById(b.featureLayer.id);var c=w.getConfigInfo(b.layerInfo,{}),d=b.layerInfo.layerObject;
this._removeSpacesInLayerTemplates(d);b.fieldInfos=this._setConfiguredFieldInfos(c.fieldInfos,b.fieldInfos);this.processConfigForRuntime(b);b.configFeatureLayer=c.featureLayer;b.featureLayer=d;b.showDeleteButton=!1}return b}var h=null;this.config.editor.configInfos.some(function(b){return b.featureLayer.id===a?(h=b,!0):!1});return h},_fillPresetValueTable:function(a){var b=!1;this._presetFieldInfos=(new ma({nls:this.nls,configInfos:a,_jimuLayerInfos:this._jimuLayerInfos,_configuredPresetInfos:this.config.editor.presetInfos,
showingInWidget:!0})).presetFieldInfos;a=n("#eePresetValueBody")[0];for(var c in this._presetFieldInfos){var d=this._presetFieldInfos[c];if(d.hasOwnProperty("type")&&"esriFieldTypeGeometry"!==d.type&&"esriFieldTypeOID"!==d.type&&"esriFieldTypeBlob"!==d.type&&"esriFieldTypeGlobalID"!==d.type&&"esriFieldTypeRaster"!==d.type&&"esriFieldTypeXML"!==d.type){b=k.create("tr");var h=k.create("td",{"class":"ee-atiLabel"});h.innerHTML=e.replace("{fieldAlias}",{fieldAlias:d.label});k.place(h,b);var q=k.create("td",
{"class":"preset-value-editable"},b);d=V.createPresetFieldContentNode(d);for(var l=null,f=null,g=0;g<d.length;g++){var m=d[g],p;this.own(r(m,"change",e.hitch(this,this._presetChange)));"dijit.form.DateTextBox"===m.declaredClass&&(l=m);"dijit.form.TimeTextBox"===m.declaredClass&&(f=m);k.place(m.domNode,q,"last");this.config.editor.presetInfos&&this.config.editor.presetInfos[c]&&(p=this.config.editor.presetInfos[c]);if(p&&0<p.length){var t=p[0];if("dijit.form.DateTextBox"===m.declaredClass||"dijit.form.TimeTextBox"===
m.declaredClass)t=""===t||null===t?null:new Date(t);m.set("value",t)}}null!==l&&this.own(r(h,"click",e.hitch(this,this._dateClick(l,f))));a.appendChild(b);b=!0}}return b},_dateClick:function(a,b){return function(){void 0!==a&&null!==a&&a.set("value",new Date);void 0!==b&&null!==b&&b.set("value",new Date)}},_getEditableLayers:function(a,b){var c=[];g.forEach(a,function(a){!a._editFlag||a.allowUpdateOnly&&!b||(a=this.map.getLayer(a.featureLayer.id))&&a.visible&&a.isVisibleAtScale(this.map.getScale())&&
a.isEditable&&a.isEditable()&&c.push(a)},this);return c},_getEditableLayersInfos:function(a,b){var c=[];g.forEach(a,function(a){if(a._editFlag&&(!a.allowUpdateOnly||b)){var d=this.map.getLayer(a.featureLayer.id);d&&d.visible&&d.isVisibleAtScale(this.map.getScale())&&d.isEditable&&d.isEditable()&&c.push(a)}},this);return c},_getClonedRelationInfo:function(a){for(var b=[],c=0;c<a.length;c++){var d={},h;for(h in a[c])a[c].hasOwnProperty(h)&&"featureLayer"!==h&&"layerInfo"!==h&&(d[h]="relationshipInfos"===
h?this._getClonedRelationInfo(a[c][h]):e.clone(a[c][h]));b.push(d)}return b},_getLayerInfoForLocalLayer:function(a){var b=this._getLayerInfoByID(a.originalLayerId);if(null!==b){var c={};for(var d in b)b.hasOwnProperty(d)&&"featureLayer"!==d&&"layerInfo"!==d&&(c[d]="relationshipInfos"===d?this._getClonedRelationInfo(b[d]):e.clone(b[d]));c.featureLayer=a}return c},_getSelectionSymbol:function(a,b){if(!a||""===a)return null;switch(a){case "esriGeometryPoint":var c=!0===b?new L(L.STYLE_CIRCLE,20,new A(A.STYLE_SOLID,
new D([0,230,169,1]),2),new D([0,230,169,.65])):new L(L.STYLE_CIRCLE,20,new A(A.STYLE_SOLID,new D([92,92,92,1]),2),new D([255,255,0,.65]));break;case "esriGeometryPolyline":c=!0===b?new A(A.STYLE_SOLID,new D([0,255,255,.65]),2):new A(A.STYLE_SOLID,new D([255,255,0,.65]),2);break;case "esriGeometryPolygon":c=!0===b?(new T).setColor(new D([0,230,169,.65])):(new T).setColor(new D([255,255,0,.65]));var d=new A(A.STYLE_SOLID,new D([192,192,192,1]),2);c.setOutline(d)}return c},_hasPresetValueFields:function(a){return a.some(function(a){return!1===
a.allowUpdateOnly?a.fieldInfos?a.fieldInfos.some(function(a){return!0===a.canPresetValue}):!1:!1},this)},_initPresetFieldsTable:function(){var a=k.create("div",{"class":"ee-presetValueTableDiv templatePicker"},this.presetFieldsTableNode);a=k.create("div",{"class":"bodyDiv"},a);a=k.create("table",{"class":"ee-presetValueBodyTable"},a);k.create("tbody",{"class":"ee-presetValueBody",id:"eePresetValueBody"},a,"first")},_setPresetValueValue:function(a,b){if(n("#eePresetValueBody")[0]){var c=n(".preset-value-editable .ee-inputField");
g.forEach(c,e.hitch(this,function(c){f.contains(c,"dijitTimeTextBox")||(c=P.byNode(c),void 0!==c&&null!==c&&c.get("name")===a&&c.set("value",b))}))}},_modifyAttributesWithPresetValues:function(a,b,c){var d=n("#eePresetValueBody")[0],h=[];if(b.fieldValues){for(var q in b.fieldValues)for(var l=0;l<b.fieldValues[q].length;l++){var f=b.fieldValues[q][l],k=!1;if(c&&"Intersection"===f.actionName&&f.enabled){for(var m=0;m<f.fields.length;m++){var p=f.fields[m];if(c.Intersection.hasOwnProperty(p.layerId)&&
c.Intersection[p.layerId].hasOwnProperty(p.field)){a[q]=c.Intersection[p.layerId][p.field];k=!0;break}}if(k)break}if(c&&"Address"===f.actionName&&f.enabled&&c.Address.hasOwnProperty(f.field)){a[q]=c.Address[f.field];break}if(c&&"Coordinates"===f.actionName&&f.enabled){a[q]=c.Coordinates[f.coordinatesSystem][f.field];break}if("Preset"===f.actionName&&f.enabled&&this._usePresetValues){h.push(q);break}}g.filter(b.fieldInfos,function(a){return-1<h.indexOf(a.name)})}d&&0<h.length&&(b=n(".preset-value-editable .ee-inputField"),
g.forEach(b,e.hitch(this,function(b){var c=P.byNode(b);if("dijit.form.TimeTextBox"!==c.declaredClass){var d=c.get("value");if(void 0!==d&&null!==d&&""!==d){if("dijit.form.DateTextBox"===c.declaredClass){var e=n(".dijitTimeTextBox",b.parentNode)[0];b=new Date(d);"Invalid Date"!==b.toString()&&(void 0!==e&&null!==e?(e=new Date(P.byNode(e).get("value")),"Invalid Date"!==e.toString()&&(b.setHours(e.getHours()),b.setMinutes(e.getMinutes()),b.setSeconds(e.getSeconds()),d=b.getTime())):d=b.getTime())}if(void 0!==
d&&null!==d&&""!==d)for(var l in a)if(a.hasOwnProperty(l)&&l===c.get("name")&&0<=h.indexOf(c.get("name"))){a[l]=d;break}}}})))},processConfigForRuntime:function(a){a&&(a._editFlag||(a.isEditable=!1),a.fieldInfos=g.filter(a.fieldInfos,function(a){return"esriFieldTypeBlob"===a.type||"esriFieldTypeGlobalID"===a.type||"esriFieldTypeRaster"===a.type||"esriFieldTypeXML"===a.type?!1:!0===a.isEditable?!0:a.visible}))},_newAttrInspectorNeeded:function(){if(!this.attrInspector||1<this.attrInspector.layerInfos.length)var a=
!0;else a=this.attrInspector.layerInfos[0].featureLayer.id,a=0<a.indexOf("_lfl")?0>a.indexOf(this.templatePicker.getSelected().featureLayer.id):!0;a&&this.attrInspector?(this.attrInspector.destroy(),this.attrInspector=null):this._attachmentUploader&&null!==this._attachmentUploader&&this._attachmentUploader.clear();return a},_onMapClick:function(a){if(this._byPass&&!0===this._byPass)this._byPass=!1;else{var b=!1;this.templatePicker&&(b=this.templatePicker.getSelected()?!0:!1);!this._attrInspIsCurrentlyDisplayed&&
a.mapPoint&&!1===b&&this._processOnMapClick(a)}},_attachmentsComplete:function(a,b,c){return function(d){var h="";g.forEach(d,function(a){a&&"rejected"===a.state&&a.error&&O.isDefined(a.error.code)&&(h=400===a.error.code?h+y.widgets.attachmentEditor.NLS_fileNotSupported+"<br/>":h+a.error.message||(a.error.details&&a.error.details.length&&a.error.details[0])+"<br/>")},this);if(""!==h)var f=new R({titleLabel:this.nls.attachmentLoadingError,width:400,maxHeight:200,autoHeight:!0,content:h,buttons:[{label:this.nls.back,
classNames:["jimu-btn"],onClick:e.hitch(this,function(){f.close()})}],onClose:e.hitch(this,function(){})});return this._completePost(a,b,c)}},_selectComplete:function(a,b){return function(){this._removeLocalLayers();this.currentFeature=null;this._showTemplate(!1);b.resolve("success")}},_completePost:function(a,b,c){this._createAttributeInspector([this.currentLayerInfo]);var d=new E;d.objectIds=[b];a.selectFeatures(d,C.SELECTION_NEW,e.hitch(this,this._selectComplete(a,c)),e.hitch(this,function(){c.resolve("failed")}))},
_postChanges:function(a){var b=new z,c=this._changed_feature(a,!1);a=c[0];var d=c[1];c=c[2];null===a?b.resolve("success"):"Add"===c?(1<this._traversal.length&&(this.addNewRelatedRecord=!0),d=this._jimuLayerInfos.getLayerOrTableInfoById(d).layerObject,c=d.applyEdits([a],null,null),this.addDeferred(c,a,d,b)):(d=this._jimuLayerInfos.getLayerOrTableInfoById(d).layerObject,0===Object.keys(a.attributes).length&&null===a.geometry?b.resolve("success"):1===Object.keys(a.attributes).length&&a.attributes.hasOwnProperty(d.objectIdField)&&
null===a.geometry?b.resolve("success"):(c=d.applyEdits(null,[a],null),this.addDeferred(c,a,d,b)));return b.promise},_changed_feature:function(a,b){var c=null,d=null,e=null;b=b||!1;var f=null;if(a){c=new Q(null,null,p.parse(p.stringify(a.attributes)));if(void 0!==this._smartAttributes&&null!==this._smartAttributes)for(f in c.attributes)if(!0===c.attributes.hasOwnProperty(f)){var l=this._smartAttributes.validateField(f);"Hide"===l[1]&&!0!==l[3]&&delete c.attributes[f]}for(f in c.attributes)!0===c.attributes.hasOwnProperty(f)&&
""===c.attributes[f]&&(c.attributes[f]=null);this._attributeInspectorTools?(c.attributes=this._attributeInspectorTools._checkFeatureData(c.attributes),a.preEditAttrs&&(c.preEditAttrs=this._attributeInspectorTools._checkFeatureData(p.parse(p.stringify(a.preEditAttrs))))):a.preEditAttrs&&(c.preEditAttrs=p.parse(p.stringify(a.preEditAttrs)));if(a.getLayer().originalLayerId){if(l=this._jimuLayerInfos.getLayerOrTableInfoById(a.getLayer().originalLayerId).layerObject)c.geometry=a.geometry,c.symbol=null,
d="Add",b=!0}else void 0!==this.geometryChanged&&null!==this.geometryChanged&&!0===this.geometryChanged&&(c.geometry=a.geometry),l=a.getLayer(),(d=w.filterOnlyUpdatedAttributes(c.attributes,c.preEditAttrs,l))&&!w.isObjectEmpty(d)?c.attributes=d:c.attributes=[],c.symbol=null,d="Update";e=l.id;c&&b&&c.attributes.hasOwnProperty(l.objectIdField)&&delete c.attributes[l.objectIdField];l.globalIdField&&c.attributes.hasOwnProperty(l.globalIdField)&&delete c.attributes[l.globalIdField];if(l.editFieldsInfo)for(f in l.editFieldsInfo)l.editFieldsInfo.hasOwnProperty(f)&&
c.attributes.hasOwnProperty(l.editFieldsInfo[f])&&delete c.attributes[l.editFieldsInfo[f]]}return[c,e,d]},addDeferred:function(a,b,c,d){a.then(e.hitch(this,function(a,f){if(f&&0<f.length&&f[0].hasOwnProperty("error"))F({message:f[0].error.toString()}),d.resolve("failed");else if(f&&0<f.length)b.preEditAttrs=p.parse(p.stringify(b.attributes)),c.refresh(),this.geometryChanged=!1,d.resolve("success");else if(a&&0<a.length&&a[0].hasOwnProperty("error"))F({message:a[0].error.toString()}),d.resolve("failed");
else if(a&&0<a.length){b.preEditAttrs=p.parse(p.stringify(b.attributes));var h=null;this.attrInspector._attachmentUploader&&(h=this.attrInspector._attachmentUploader.postAttachments(c,a[0].objectId));void 0===h||null===h||0===h.length?this.addNewRelatedRecord?d.resolve("success"):this._completePost(c,a[0].objectId,d):K(h).then(e.hitch(this,this._attachmentsComplete(c,a[0].objectId,d)))}}),e.hitch(this,function(a){F({message:a.message.toString()+"\n"+a.details});d.resolve("failed")}))},_processOnMapClick:function(a){this.map.infoWindow.hide();
g.forEach(this._attributeInspectorCollection,function(a){a.destroy()});this._traversal=[];this._nodesCollection=[];this._paginationNodeCollection=[];this._buttonsWrapper=[];this._attributeInspectorCollection=[];this._relatedTablesInfo={};this._createAttributeInspector(this.config.editor.configInfos);var b=this.map.getLayersVisibleAtScale().filter(e.hitch(this,function(a){return a.type&&"Feature Layer"===a.type&&a.url?g.some(this.config.editor.configInfos,e.hitch(this,function(b){return b.layerId===
a.id&&this._hasAnyEditableLayerInRelation([b])?!0:!1})):!1}));b=b.filter(e.hitch(this,function(a){try{return this.map.getLayer(a.id).visible}catch(q){return console.log(q+" Check for visible failed"),!0}}));var c=[],d=[];this.currentFeature=null;this.geometryChanged=!1;this.currentLayerInfo=null;g.forEach(b,e.hitch(this,function(b){b.setSelectionSymbol(this._getSelectionSymbol(b.geometryType,!1));var f=new E;f.geometry=w.pointToExtent(this.map,a.mapPoint,20);f=b.selectFeatures(f,C.SELECTION_NEW,e.hitch(this,
function(a){var f=[],h=[];g.forEach(a,function(a){a.allowDelete=!0;b.getEditCapabilities({feature:a}).canDelete||(a.allowDelete=!1);a.preEditAttrs=p.parse(p.stringify(a.attributes));h.push(a)},this);0<f.length&&(a=new E,a.objectIds=f,f=b.selectFeatures(a,C.SELECTION_SUBTRACT,e.hitch(this,function(a){console.log(a.length)})),d.push(f));c=c.concat(h)}));d.push(f)}));0===d.length?(this._byPass=!0,this.map.popupManager._showPopup(a),this._byPass=!1):K(d).then(e.hitch(this,function(){this.updateFeatures=
c;0<this.updateFeatures.length?this._showTemplate(!1):(this._byPass=!0,this.map.popupManager._showPopup(a),this._byPass=!1)}))},_attachLayerHandler:function(){this._eventHandler=this.own(r(this.currentFeature._layer,"visibility-change",e.hitch(this,function(){})))},_removeLayerVisibleHandler:function(){null!==this._eventHandler&&(g.forEach(this._eventHandler,e.hitch(this,function(a){"function"===typeof a.remove&&a.remove()})),this._eventHandler=null)},_postFeatureSave:function(a){this.updateFeatures&&
1<this.updateFeatures.length&&g.forEach(this.updateFeatures,e.hitch(this,function(a){a.setSymbol(this._getSelectionSymbol(a.getLayer().geometryType,!1))}));a&&a.feature&&(this.geometryChanged=!1,this.currentFeature=a.feature,this.currentFeature.preEditAttrs=p.parse(p.stringify(this.currentFeature.attributes)),this._attachLayerHandler(),this.currentLayerInfo=this._getLayerInfoByID(this.currentFeature._layer.id),this.currentLayerInfo.isCache=!1,this._createSmartAttributes(),this._createAttributeInspectorTools(),
this._attributeInspectorTools.triggerFormValidation(),this._validateAttributes(),this._enableAttrInspectorSaveButton(!1),this.currentFeature.hasOwnProperty("allowDelete")?this._toggleDeleteButton(this.currentFeature.allowDelete&&this.currentLayerInfo.allowDelete):this._toggleDeleteButton(this.currentLayerInfo.allowDelete),this._toggleEditGeoSwitch(this.currentLayerInfo.disableGeometryUpdate||!this.currentLayerInfo.configFeatureLayer.layerAllowsUpdate||this.currentLayerInfo.featureLayer.hasZ&&!this.currentLayerInfo.featureLayer.enableZDefaults||
this.currentLayerInfo.featureLayer.hasM&&!this.currentLayerInfo.featureLayer.allowUpdateWithoutMValues),this.currentFeature.setSymbol(this._getSelectionSymbol(a.feature.getLayer().geometryType,!0)))},_promptToDelete:function(){var a=new R({titleLabel:this.nls.deletePromptTitle,width:400,maxHeight:200,autoHeight:!0,content:this.nls.deletePrompt,buttons:[{label:this.nls.yes,classNames:["jimu-btn"],onClick:e.hitch(this,function(){this._deleteFeature();a.close()})},{label:this.nls.no,classNames:["jimu-btn"],
onClick:e.hitch(this,function(){a.close()})}],onClose:e.hitch(this,function(){})})},_promptToResolvePendingEdit:function(a,b,c,d){d=!this._validateAttributes();var f=new z;d=[{label:this.nls.yes,classNames:["jimu-btn"],disable:d,onClick:e.hitch(this,function(){this._saveEdit(this.currentFeature,a,!0).then(e.hitch(this,function(){null!==b&&void 0!==b&&(b.hasOwnProperty("featureLayer")&&b.hasOwnProperty("feature")?this.load_from_featureaction(b.featureLayer,b.feature):this._postFeatureSave(b));f.resolve("yes")}));
g.close()})},{label:this.nls.no,classNames:["jimu-btn"],onClick:e.hitch(this,function(){this._cancelEditingFeature(a);null!==b&&void 0!==b&&(b.hasOwnProperty("featureLayer")&&b.hasOwnProperty("feature")?this.load_from_featureaction(b.featureLayer,b.feature):this._postFeatureSave(b));g.close();f.resolve("no")})}];c&&!0===c&&d.push({label:this.nls.back,classNames:["jimu-btn"],onClick:e.hitch(this,function(){f.reject();g.close()})});var g=new R({titleLabel:this.nls.savePromptTitle,width:400,maxHeight:200,
autoHeight:!0,content:this.nls.savePrompt,buttons:d,onClose:e.hitch(this,function(){})});return f.promise},_removeLocalLayers:function(){this.cacheLayer&&null!==this.cacheLayer&&(this.cacheLayer.clearSelection(),this.cacheLayer.clear(),this.map.removeLayer(this.cacheLayer),this.cacheLayer=null);this.updateFeatures=[]},_removeSpacesInLayerTemplates:function(a){if(a){var b=g.filter(a.fields,e.hitch(this,function(a){return!1===a.nullable&&!0===a.editable}));g.forEach(b,e.hitch(this,function(b){g.forEach(a.templates,
function(a){" "===a.prototype.attributes[b.name]&&(a.prototype.attributes[b.name]=a.prototype.attributes[b.name].trim())})}))}},_resetEditingVariables:function(){this._editingEnabled=!1;this.editToolbar&&0!==this.editToolbar.getCurrentState().tool&&this.editToolbar.deactivate()},_feature_removed:function(a,b){return function(){this.attrInspector._featureIdx>=b&&0!==b&&(this.currentFeature=null,this.attrInspector.previous());this.updateFeatures.splice(this.updateFeatures.indexOf(a),1)}},_saveEdit:function(a,
b,c){if(document.getElementById("vc").value.trim()==a.attributes.TaxParcelNumber){var d=new z;this._enableAttrInspectorSaveButton(!1);this._turnEditGeometryToggleOff();if(this._validateAttributes()){var h=n(".processing-indicator"),q=n(".processing-indicator-panel"),l=n(".saveButton",this.buttonHeader)[0];g.forEach(h,function(a){f.contains(a,"busy")||f.add(a,"busy")});g.forEach(q,function(a){f.contains(a,"busy")||f.add(a,"busy")});l&&!f.contains(l,"hide")&&f.add(l,"hide");this._postChanges(a).then(e.hitch(this,
function(c){var n=!1;if("failed"===c)d.resolve("failed"),this.addNewRelatedRecord=!1;else{this.addNewRelatedRecord&&(n=!0,this.attrInspector.destroy(),k.destroy(this.contentWrapper),k.destroy(this.buttonHeader),this.attrInspector=this._attributeInspectorCollection.pop(),m.set(this.attrInspector.attributeTable,"display","block"),m.set(this.attrInspector.editButtons,"display","block"),m.set(this.attrInspector.deleteBtn.domNode,"display","none"),this.attrInspector._featureIdx=this.attrInspector.ctStoredFeatureIndex,
this.attrInspector.refresh(),setTimeout(e.hitch(this,function(){m.set(this.attrInspector.navButtons,"display",!this.attrInspector._hideNavButtons&&1<this.attrInspector._numFeatures?"":"none");this.attrInspector.navMessage.innerHTML=O.substitute({idx:this.attrInspector._featureIdx+1,of:this.attrInspector.NLS_of,numFeatures:this.attrInspector._numFeatures},this.attrInspector._navMessage);(this.currentFeature=this.attrInspector._numFeatures?this.attrInspector._selection[this.attrInspector._featureIdx]:
null)&&this.currentFeature.attributes&&(this.currentFeature.preEditAttrs=p.parse(p.stringify(this.currentFeature.attributes)))}),200),this.contentWrapper=this._nodesCollection.pop(),this.buttonHeader=this._buttonsWrapper.pop(),this._traversal.pop(),this.currentRelatedDom&&(c=x.get(this.currentRelatedDom,"relatedRecordCount"))&&0===parseInt(c,10)&&x.set(this.currentRelatedDom,"relatedRecordCount",1),this.currentRelatedDom.click());this.currentFeature&&this.currentFeature.attributes&&(this.currentFeature.preEditAttrs=
p.parse(p.stringify(this.currentFeature.attributes)));this._relatedTablesInfo[a._layer.id]&&this._relatedTablesInfo[a._layer.id].updateFeatureInstance(a.attributes);this.config.editor.removeOnSave&&1>=this.updateFeatures.length&&1>=this._traversal.length&&!n&&(b=!0);if(b&&!0===b)this._showTemplate(!0);else if(this.config.editor.removeOnSave&&1>=this.updateFeatures.length&&1<this._traversal.length)r.emit(this.cancelButton,"click",{cancelable:!0,bubbles:!0});else if(this._resetEditingVariables(),this.map.setInfoWindowOnClick(!0),
!0!==this.config.editor.removeOnSave||n)this.currentFeature&&this.currentFeature.hasOwnProperty("allowDelete")?this._toggleDeleteButton(this.currentFeature.allowDelete&&this.currentLayerInfo.allowDelete):this._toggleDeleteButton(this.currentLayerInfo.allowDelete&&this.currentLayerInfo.configFeatureLayer.layerAllowsDelete),this._toggleEditGeoSwitch(this.currentLayerInfo.disableGeometryUpdate||!this.currentLayerInfo.configFeatureLayer.layerAllowsUpdate||this.currentLayerInfo.featureLayer.hasZ&&!this.currentLayerInfo.featureLayer.enableZDefaults||
this.currentLayerInfo.featureLayer.hasM&&!this.currentLayerInfo.featureLayer.allowUpdateWithoutMValues),this.currentLayerInfo.featureLayer.visibleAtMapScale&&this.config.editor.hasOwnProperty("editGeometryDefault")&&!0===this.config.editor.editGeometryDefault&&setTimeout(e.hitch(this,function(){2>this._traversal.length&&this._editGeomSwitch.set("checked",!0)}),100),a.setSymbol(this._getSelectionSymbol(a.getLayer().geometryType,!0));else{n=a.getLayer();c=new E;c.objectIds=[a.attributes[n.objectIdField]];
var v=this.attrInspector._selection.indexOf(a);n.selectFeatures(c,C.SELECTION_SUBTRACT,e.hitch(this,this._feature_removed(a,v)))}d.resolve("success")}g.forEach(h,function(a){f.contains(a,"busy")&&f.remove(a,"busy")});g.forEach(q,function(a){f.contains(a,"busy")&&f.remove(a,"busy")});f.contains(l,"hide")&&f.remove(l,"hide")}),e.hitch(this,function(){g.forEach(h,function(a){f.contains(a,"busy")&&f.remove(a,"busy")});g.forEach(q,function(a){f.contains(a,"busy")&&f.remove(a,"busy")});f.contains(l,"hide")&&
f.remove(l,"hide")}))}return d.promise}document.getElementById("vc").focus();alert("ERROR: Incorrect Validation Code for this location.")},_showTemplate:function(a){this._attrInspIsCurrentlyDisplayed=!a;a?(this._mapClickHandler(!0),this._showTemplatePicker(),this._traversal=[],this._nodesCollection=[],this._paginationNodeCollection=[],this._buttonsWrapper=[],this._attributeInspectorCollection=[],this._relatedTablesInfo={},this.currentFeature=null,this.geometryChanged=!1,this.currentLayerInfo=null):
(this._mapClickHandler(!1),n(".jimu-widget-smartEditor .templatePickerMainDiv")[0].style.display="none",n(".jimu-widget-smartEditor .attributeInspectorMainDiv")[0].style.display="block",this.attrInspector&&(!this.currentFeature&&this.attrInspector&&0<this.attrInspector._numFeatures&&this.attrInspector.first(),this.attrInspector.refresh(),this._createSmartAttributes(),this._createAttributeInspectorTools(),this._attributeInspectorTools.triggerFormValidation(),this.currentFeature&&this.currentFeature.getLayer().originalLayerId?
this._enableAttrInspectorSaveButton(this._validateAttributes()):(this._validateAttributes(!1),this._enableAttrInspectorSaveButton(!1)),this.currentLayerInfo.isCache&&!0===this.currentLayerInfo.isCache?this._toggleEditGeoSwitch(!1):this._toggleEditGeoSwitch(this.currentLayerInfo.disableGeometryUpdate||!this.currentLayerInfo.configFeatureLayer.layerAllowsUpdate||this.currentLayerInfo.featureLayer.hasZ&&!this.currentLayerInfo.featureLayer.enableZDefaults||this.currentLayerInfo.featureLayer.hasM&&!this.currentLayerInfo.featureLayer.allowUpdateWithoutMValues),
this._addWarning()),this._recordLoadeAttInspector())},_createAttributeInspectorTools:function(){if(void 0!==this.currentFeature&&null!==this.currentFeature){var a=n("td.atiLabel",this.attrInspector.domNode);void 0!==a&&null!==a&&(this._attributeInspectorTools=new oa({_attrInspector:this.attrInspector,_feature:this.currentFeature,_fieldInfo:this.currentLayerInfo.fieldInfos}))}},_createSmartAttributes:function(){if(void 0!==this.currentFeature&&null!==this.currentFeature){var a=n("td.atiLabel",this.attrInspector.domNode);
void 0!==a&&null!==a&&(a=null,void 0!==this.currentLayerInfo&&null!==this.currentLayerInfo&&void 0!==this.currentLayerInfo.fieldValidations&&null!==this.currentLayerInfo.fieldValidations&&(a=this.currentLayerInfo.fieldValidations),null!==a&&(this._smartAttributes=new na({_attrInspector:this.attrInspector,_fieldValidation:a,_feature:this.currentFeature,_fieldInfo:this.currentLayerInfo.fieldInfos,_url:this.currentLayerInfo.featureLayer.url})))}},_showTemplatePicker:function(){n(".jimu-widget-smartEditor .attributeInspectorMainDiv")[0].style.display=
"none";n(".jimu-widget-smartEditor .templatePickerMainDiv")[0].style.display="block";if(this.templatePicker&&(this.config.editor.hasOwnProperty("keepTemplateSelected")?!0!==this.config.editor.keepTemplateSelected&&this.templatePicker.clearSelection():this.templatePicker.clearSelection(),this.templatePicker)){var a=null;this.drawingTool&&this.currentDrawType&&(a=this.currentDrawType);this._activateTemplateToolbar(a);this.templatePicker.update()}this._resetEditingVariables();var b=[];this.updateFeatures&&
g.forEach(this.updateFeatures,e.hitch(this,function(a){a=a.getLayer();b&&-1===b.indexOf(a.id)&&(b.push(a.id),a.clearSelection(),a.refresh())}));this._clearLayerSelection();this.currentFeature=null;this.geometryChanged=!1;this.currentLayerInfo=null;this._removeLocalLayers();!0===this._recreateOnNextShow&&(this._recreateOnNextShow=!1,this._createEditor());this._creationDisabledOnAll?(this.templatePicker&&u.style(this.templatePicker.domNode,"display","none"),this.drawingTool&&u.style(this.drawingTool.domNode,
"display","none")):(this.templatePicker&&u.style(this.templatePicker.domNode,"display","block"),this.drawingTool&&u.style(this.drawingTool.domNode,"display","block"))},_setPresetValue:function(){this._usePresetValues=M.byId("savePresetValueSwitch").checked},_toggleUsePresetValues:function(a){var b=M.byId("savePresetValueSwitch");b.set("checked",null===a?!b.checked:a);this._usePresetValues=b.checked},_turnEditGeometryToggleOff:function(){1<this._traversal.length||!this._editGeomSwitch||!this._editGeomSwitch.checked||
(this.editToolbar&&0!==this.editToolbar.getCurrentState().tool&&this.editToolbar.deactivate(),this._editingEnabled=!1,this._ignoreEditGeometryToggle=!0,this._editGeomSwitch.set("checked",!1),this.map.setInfoWindowOnClick(!0),setTimeout(e.hitch(this,function(){this._ignoreEditGeometryToggle=!1}),2))},_validateFeatureChanged:function(){if(this.currentFeature){if(void 0!==this.geometryChanged&&null!==this.geometryChanged&&!0===this.geometryChanged)return!0;var a=this._changed_feature(this.currentFeature,
!0),b=a[0];a=a[2];if(null!==b&&0===Object.keys(b.attributes).length&&"Add"!==a)return!1}return!0},_validateRequiredFields:function(){var a={};if(!this.currentFeature)return a;var b=this.currentFeature.getLayer();b=g.filter(b.fields,e.hitch(this,function(a){return!1===a.nullable&&!0===a.editable}));g.forEach(b,e.hitch(this,function(b){if("undefined"===this.currentFeature.attributes[b.name])a[b.alias]="undefined";else if(null===this.currentFeature.attributes[b.name])a[b.alias]="null";else switch(b.type){case "esriFieldTypeString":if(""===
this.currentFeature.attributes[b.name]||this.currentFeature.attributes[b.name]&&""===this.currentFeature.attributes[b.name].trim())a[b.alias]="Empty string"}}));return a},_worksAfterClose:function(){y.toolbars.draw.start=this._defaultStartStr;y.toolbars.draw.addPoint=this._defaultAddPointStr},_workBeforeCreate:function(){var a="<br/>("+this.nls.pressStr+"<b>"+this.nls.ctrlStr+"</b> "+this.nls.snapStr+")";this._defaultStartStr=y.toolbars.draw.start;this._defaultAddPointStr=y.toolbars.draw.addPoint;
y.toolbars.draw.start+=a;y.toolbars.draw.addPoint+=a},_getDefaultFieldInfos:function(a){var b=w.getFieldInfosFromWebmap(a.id,this._jimuLayerInfos);if(void 0===b||null===b)b=w.getFieldInfosLayer(a.id,this._jimuLayerInfos);b&&(b=g.filter(b,function(a){return a.visible||a.isEditable}));return b},_getDefaultLayerInfos:function(){for(var a=[],b,c=this.map.graphicsLayerIds.length-1;0<=c;c--)if(b=this.map.getLayer(this.map.graphicsLayerIds[c]),"Feature Layer"===b.type&&b.url){var d={featureLayer:{}};d.featureLayer.id=
b.id;d.disableGeometryUpdate=!1;d.allowUpdateOnly=!1;(b=this._getDefaultFieldInfos(b))&&0<b.length&&(d.fieldInfos=b);a.push(d)}return a},_converConfiguredLayerInfos:function(a){g.forEach(a,function(a){var b;if(!a.featureLayer.id&&a.featureLayer.url){if(b=this.getLayerObjectFromMapByUrl(this.map,a.featureLayer.url))a.featureLayer.id=b.id}else b=this.map.getLayer(a.featureLayer.id);var d=a.featureLayer.id;a.featureLayer.hasOwnProperty("originalLayerId")&&(d=a.featureLayer.originalLayerId);if(b){var e=
[],f=w.getFieldInfosFromWebmap(d,this._jimuLayerInfos);if(void 0===f||null===f)f=w.getFieldInfosLayer(d,this._jimuLayerInfos);g.forEach(f,function(c){c.fieldName!==b.globalIdField&&c.fieldName!==b.objectIdField&&"esriFieldTypeGeometry"!==c.type&&"esriFieldTypeOID"!==c.type&&"esriFieldTypeBlob"!==c.type&&"esriFieldTypeGlobalID"!==c.type&&"esriFieldTypeRaster"!==c.type&&"esriFieldTypeXML"!==c.type&&(c=this.getFieldInfoFromWebmapFieldInfos(c,a.fieldInfos),!0===c.visible&&e.push(c))},this);0!==e.length&&
(a.fieldInfos=e)}},this);return a},getLayerObjectFromMapByUrl:function(a,b){for(var c=null,d=0;d<a.graphicsLayerIds.length;d++){var e=a.getLayer(a.graphicsLayerIds[d]);if(e.url.toLowerCase()===b.toLowerCase()){c=e;break}}return c},getFieldInfoFromWebmapFieldInfos:function(a,b){var c={},d=g.filter(b,function(b){return a.fieldName===b.fieldName});d&&(c=1<=d.length?d[0]:a);c.label=void 0===c.label?a.label:c.label;c.visible=void 0===c.visible?a.visible:c.visible;c.isEditableSettingInWebmap=void 0===a.isEditable?
!0:a.isEditable;c.isEditable=void 0===c.isEditable?a.isEditable:c.isEditable;c.canPresetValue=void 0===c.canPresetValue?!1:c.canPresetValue;c.format=void 0===a.format?null:a.format;for(var e in a)a.hasOwnProperty(e)&&!1===c.hasOwnProperty(e)&&(c[e]=a[e]);return c},getConfigDefaults:function(){this.config.editor.hasOwnProperty("editGeometryDefault")&&!0===this.config.editor.editGeometryDefault?setTimeout(e.hitch(this,function(){2>this._traversal.length&&this._editGeomSwitch.domNode&&this._editGeomSwitch.set("checked",
!0)}),100):this._turnEditGeometryToggleOff()},_processConfig:function(){g.forEach(this.config.editor.configInfos,function(a){a.hasOwnProperty("_editFlag")||(a._editFlag=!0);var b=a.layerInfo.layerObject;b&&(!1===a.allowUpdateOnly&&this.own(r(b,"visibility-change, scale-visibility-change",e.hitch(this,function(){this._layerScaleClearedTimer&&clearTimeout(this._layerScaleClearedTimer);this._layerScaleClearedTimer=setTimeout(e.hitch(this,function(){this._createEditor()}),200)}))),this._removeSpacesInLayerTemplates(b),
this.processConfigForRuntime(a),a.configFeatureLayer=a.featureLayer,a.featureLayer=b,a.showDeleteButton=!1)},this)},onClose:function(){this._worksAfterClose();this._mapClickHandler(!1);this._removeLayerVisibleHandler();this._unLockMapNavigation();this._onCancelButtonClicked()},_update:function(){},resize:function(){this._update()},onNormalize:function(){setTimeout(e.hitch(this,this._update),100)},onMinimize:function(){console.log("min")},onMaximize:function(){setTimeout(e.hitch(this,this._update),
100)},addItem:function(a,b,c,d,e,g){var h=k.create("div",{"class":"esriCTItem"},null);this._createItemTitle(a,h,b,e,g);this._createItemContent(h,b,d);e&&f.add(h,"esriCTDisableToggling");c.appendChild(h);return h},_createItemTitle:function(a,b,c,d,h){var g=k.create("div",{"class":"esriCTItemTitleContainer"},b);k.create("div",{"class":"esriCTItemHighlighter"},g);a=k.create("div",{"class":"esriCTItemTitle esriCTFloatLeft",innerHTML:a,title:a},g);1>=this._traversal.length&&h&&!h.visibleAtMapScale&&(a.style.opacity=
"0.3");h=k.create("div",{"class":"itemTitleArrowIcon"},g);c?f.add(h,"itemTitleUpArrow"):f.add(h,"itemTitleDownArrow");this.own(r(g,"click",e.hitch(this,function(a){f.contains(a.currentTarget.parentElement,"esriCTDisableToggling")||d||this._togglePanel(b)})))},_createItemContent:function(a,b,c){var d=k.create("div",{"class":"esriCTItemContent esriCTRelatedItemContent"},a);b?((b=this._fetchLayerDescription(c))&&k.create("div",{"class":"editDescription",innerHTML:b},d),k.place(this.attrInspector.domNode,
d,"last"),this._togglePanel(a)):this._relatedTablesInfo[this.attrInspector._currentFeature._layer.id]&&this._relatedTablesInfo[this.attrInspector._currentFeature._layer.id].domNode&&k.place(this._relatedTablesInfo[this.attrInspector._currentFeature._layer.id].domNode,d,"last")},_togglePanel:function(a){var b=n(".esriCTItemTitle",a)[0];var c=n(".itemTitleArrowIcon",a)[0];var d=n(".esriCTItemContent",a)[0];var e=n(".esriCTItemHighlighter",a)[0];b&&d&&!f.contains(a,"esriCTDisableToggling")&&(f.contains(d,
"esriCTItemContentActive")?(m.set(e,"backgroundColor","transparent"),f.replace(c,"itemTitleDownArrow","itemTitleUpArrow")):(m.set(e,"backgroundColor",this.config.selectedThemeColor),f.replace(c,"itemTitleUpArrow","itemTitleDownArrow")),f.toggle(d,"esriCTItemContentActive"))},_disableToggling:function(a){a&&f.add(a,"esriCTDisableToggling")},_fetchLayerDescription:function(a){var b=this.config.editor.layerInfos;this._traversal&&0<this._traversal.length?g.some(this._traversal,function(a,c){g.some(b,
function(c){if(c.featureLayer.id===a)return b=c,!0});1<this._traversal.length&&c+1<this._traversal.length&&(b=b.relationshipInfos)},this):g.some(b,function(c){if(c.featureLayer.id===a)return b=c,!0});if(b.editDescription)var c=b.editDescription;return c},_getRelationshipInfo:function(a){var b=a._layer.id;if(this._traversal&&0<this._traversal.length){var c=this.config.editor.configInfos;g.some(this._traversal,function(a,b){g.some(c,function(b){if(b.featureLayer.id===a)return c=b,!0});1<this._traversal.length&&
b+1<this._traversal.length&&(c=c.relationshipInfos)},this);return c.relationshipInfos}var d=null;this.config.editor.configInfos.some(function(a){return a.featureLayer.id===b?(d=a.relationshipInfos,!0):!1});return d},_getSelectedThemeColor:function(){this.config.selectedThemeColor="#000000";var a=this.appConfig.theme.name;var b=this.appConfig&&this.appConfig.theme&&this.appConfig.theme.styles?this.appConfig.theme.styles[0]:"default";this.appConfig&&this.appConfig.theme&&this.appConfig.theme.customStyles&&
this.appConfig.theme.customStyles.mainBackgroundColor?this.config.selectedThemeColor=this.appConfig.theme.customStyles.mainBackgroundColor:ia({url:"./themes/"+a+"/manifest.json",content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(e.hitch(this,function(a){var c;if(a&&a.styles&&0<a.styles.length)for(c=0;c<a.styles.length;c++){var e=a.styles[c];if(e.name===b){this.config.selectedThemeColor=e.styleColor;break}}}))},_getRelatedRecordsByRelatedQuery:function(a,b,c,d){var f=new z,k=new la,
l=this._jimuLayerInfos.getLayerOrTableInfoById(c).layerObject.objectIdField;k.returnGeometry=!1;k.outSpatialReference=this.map.spatialReference;k.relationshipId=b;k.objectIds=[d];k.outFields=[l];this.loading.show();a.queryRelatedFeatures(k,e.hitch(this,function(a){var b=[];g.forEach(a[d]&&a[d].features,function(a){b.push(a.attributes[l])});this.loading.hide();f.resolve(b)}),e.hitch(this,function(){this.loading.hide();f.resolve([])}));return f},_getCurrentFieldDijit:function(a){var b;g.some(this.attrInspector._currentLInfo.fieldInfos,
e.hitch(this,function(c){if(c.name===a)return b=c.dijit,!0}));return b},_updateRefreshButtonState:function(){var a;if(this._refreshButton&&this.config.editor.enableAttributeUpdates)if(this.config.editor.enableAutomaticAttributeUpdates)f.remove(this._refreshButton,"hidden"),f.contains(this._refreshButton,"esriCTAutoUpdateOnMode")&&this._refreshAttributes();else if(x.has(this._refreshButton,"hasGeometryDependency"))(a=x.get(this._refreshButton,"hasGeometryDependency"))&&f.remove(this._refreshButton,
"hidden");else if(this.currentLayerInfo.fieldValues){a=!1;for(var b in this.currentLayerInfo.fieldValues){for(var c=0;c<this.currentLayerInfo.fieldValues[b].length;c++){var d=this.currentLayerInfo.fieldValues[b][c];if("Intersection"===d.actionName&&d.enabled){a=!0;break}if("Address"===d.actionName&&d.enabled){a=!0;break}if("Coordinates"===d.actionName&&d.enabled){a=!0;break}}if(a)break}x.set(this._refreshButton,"hasGeometryDependency",a);a&&f.remove(this._refreshButton,"hidden")}},_refreshAttributes:function(){this.loading.show();
this._getCopyAttributes(this.currentLayerInfo,this.currentFeature.geometry).then(e.hitch(this,function(a){if(this.currentLayerInfo.fieldValues)for(var b in this.currentLayerInfo.fieldValues)for(var c=0;c<this.currentLayerInfo.fieldValues[b].length;c++){var d=this.currentLayerInfo.fieldValues[b][c],e=!1,f=!0,g=null;if(a&&"Intersection"===d.actionName&&d.enabled){for(g=0;g<d.fields.length;g++){var k=d.fields[g];if(a.Intersection.hasOwnProperty(k.layerId)&&a.Intersection[k.layerId].hasOwnProperty(k.field)){g=
a.Intersection[k.layerId][k.field];this._setValuesInDijits(b,g);e=!0;f=!1;break}}if(e)break}if(a&&"Address"===d.actionName&&d.enabled&&a.Address.hasOwnProperty(d.field)){g=a.Address[d.field];this._setValuesInDijits(b,g);f=!1;break}if(a&&"Coordinates"===d.actionName&&d.enabled){g=a.Coordinates[d.coordinatesSystem][d.field];this._setValuesInDijits(b,g);f=!1;break}if("Preset"===d.actionName&&d.enabled&&this._usePresetValues){f=!1;break}f&&d.enabled&&("Intersection"===d.actionName||"Address"===d.actionName||
"Coordinates"===d.actionName)&&this._setValuesInDijits(b,null)}this.loading.hide();setTimeout(function(){aa.curNode&&aa.curNode.blur()},100)}))},_setValuesInDijits:function(a,b){var c=this._getCurrentFieldDijit(a);var d=null;c&&c.set?(c.set("value",b,!0),c.focus()):c&&0<c.length&&(b&&(d=new Date(b)),c[0]&&c[0].set("value",d,!0),1<c.length&&c[1]&&c[1].set("value",d,!0))}})});